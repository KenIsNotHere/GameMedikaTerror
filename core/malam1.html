<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malam 1 - Mari Kita Ungkap</title>
    <style>
        /* --- RESET & SYSTEM --- */
        * { padding: 0; margin: 0; box-sizing: border-box; user-select: none; }
        
        body {
            background-color: black;
            width: 100vw; height: 100vh;
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }
        /* --- LOADING SCREEN --- */
        /* Overlay Loading Screen */
        #loading-screen {
            position: fixed;
            font-size: 100%;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #0f0f0f; 
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999; 
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        #preRenderingIMGwrapper{
            z-index: 0;
            opacity: 0.01;
            position: absolute;
        }

        .progress-container {
            width: 100%;
            height: 20%;
            background-color: #000000;
            overflow: hidden;
            margin: 2% 0;
            border: 1px solid #555;
        }

        #progress-bar {
            width: 0%;
            height: 100%;
            background-color: #ffffff; 
            transition: width 0.2s ease; 
        }

        .loader-content {
            text-align: center;
            height: 15%;
            width: 60%;
        }

        #loading-screen.hide {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        /* --- VIEWPORT --- */
        #viewport {
            position: relative;
            background-color: #111;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            animation: breathingView 4s infinite ease-in-out, animasiLampuRedup 5s infinite alternate;
            transform-origin: center center;
        }

        @keyframes breathingView {
            0%, 100% { transform: translateY(0px) scale(1); }
            50% { transform: translateY(-0.5%) scale(1.005); }
        }
        @keyframes animasiLampuRedup {
            0% { filter: brightness(0.8); }
            100% { filter: brightness(1); }
        }

        @media (min-aspect-ratio: 16/9) {
            #viewport { height: 100vh; width: 177.78vh; }
            html { font-size: 2vh; } 
        }
        @media (max-aspect-ratio: 16/9) {
            #viewport { width: 100vw; height: 56.25vw; }
            html { font-size: 2vw; }
        }

        /* --- TRANSITION OVERLAY (LAYAR HITAM) --- */
        #transitionOverlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: black;
            z-index: 100; /* Paling atas */
            opacity: 0;   /* Default tidak terlihat */
            pointer-events: none; /* Agar bisa klik tembus saat transparan */
            transition: opacity 1s ease-in-out; /* Animasi Fade 1 Detik */
        }

        /* --- PANORAMA --- */
        #main {
            display: flex; width: 300%; height: 100%;
            position: absolute; top: 0; left: 0; will-change: transform;
        }
        .main-img { width: 33.3333%; height: 100%; object-fit: cover; display: block; }

        /* --- NAVIGATION BUTTON --- */
        .nav-btn {
            position: absolute;
            z-index: 10;
            padding: 0.3% 0.45%;
            background-color: rgba(0, 150, 255, 0.15);
            border : 0.2vh solid rgba(0, 149, 255, 0);
            color: rgba(200, 230, 255, 0.306);
            box-shadow: 0 0 15px rgba(0, 150, 255, 0.3);
            backdrop-filter: blur(2px);
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
            font-size: 70%;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            transform: translate(-50%, -50%); /* Center anchor */
        }
        
        .nav-btn:hover {
            background-color: rgba(0, 149, 255, 0.349);
            box-shadow: 0 0 25px rgba(0, 150, 255, 0.6);
            border : 0.2vh solid rgba(0, 149, 255, 0.459);
            color: white;
        }

        /* --- TRIGGERS --- */
        .viewSide { position: absolute; width: 15%; height: 100%; z-index: 50; top: 0; }
        #viewLeftBox { left: 0; }
        #viewRightBox { right: 0; }

        /* --- UI LAYER --- */
        #UI { position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 60; }

        /* TOMBOL CCTV UTAMA */
        #cctvBtn {
            pointer-events: auto; position: absolute; bottom: 5%; left: 50%;
            transform: translateX(-50%); width: 50%; padding: 0.5%;
            background-color: rgba(0, 128, 0, 0.2); backdrop-filter: blur(5px);
            color: rgba(255, 255, 255, 0.8); text-align: center; font-size: 1.2rem; font-weight: bold;
            cursor: pointer; border: 1px solid rgba(255,255,255,0.1); transition: all 0.2s ease;
        }
        #cctvBtn:hover { background-color: rgba(0, 128, 0, 0.5); }
        #cctvBtn.btn-red { background-color: rgba(200, 0, 0, 0.6) !important; border-color: red; color: white; }
        #cctvBtn.btn-red:hover { background-color: rgba(200, 0, 0, 0.9) !important; }

        /* MONITOR CONTAINER */
        #cctvContainer {
            position: absolute; width: 100%; height: 100%;
            perspective: 1000px; display: flex; justify-content: center; pointer-events: none; overflow: hidden;
        }
        #monitorWrapper {
            width: 65%; position: absolute; bottom: 0; transform-origin: bottom center;
            transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); pointer-events: auto; cursor: pointer; 
        }
        #cctvFrame { width: 100%; display: block; position: relative; z-index: 1; transition: filter 0.2s; }
        #cctvScreen {
            position: absolute; z-index: 2; width: 65%; left: 16.6%; top: 15%; aspect-ratio: 4/3; 
            object-fit: cover; display: none; box-shadow: 0 0 20vw rgba(255, 126, 51, 0.148);
        }

        /* --- CCTV UI (MAP & CONTROLS) --- */
        #cctvUiLayer {
            position: absolute; z-index: 3; width: 65%; left: 16.6%; top: 15%; aspect-ratio: 4/3;
            pointer-events: none; display: none;
        }

        /* --- ENTITY DISPLAY ON CCTV --- */
        #cctvEntityRustwalkerDisplay {
            position: absolute;
            z-index: 3; /* Di atas gambar Background Ruangan (Level 2), tapi di bawah UI (Level 3 ke atas) */
            
            /* Menyamakan posisi dengan #cctvScreen agar koordinat akurat */
            width: 65%; 
            left: 16.6%; 
            top: 15%; 
            aspect-ratio: 4/3; 
            
            object-fit: contain; /* Agar gambar tidak gepeng */
            pointer-events: none; /* Agar klik tembus ke map di belakangnya jika perlu */
            display: none; /* Sembunyi default */
            
            /* Default Anchor di tengah agar mudah mengatur posisi */
            transform-origin: center center;
        }

        /* NAVBAR JAM */
        #cctvNavbar{
            position: absolute; background-color: rgb(0, 0, 0); border-bottom: 0.3vw solid rgb(39, 88, 13);
            width: 100%; height: 5%; top: -5%; font-size: 1.6vw; color: white;
            display: flex; align-items: center; padding-left: 2%; 
            font-family: 'Courier New', Courier, monospace; font-weight: bold;
        }

        #mapContainer {
            position: absolute; bottom: 5%; right: 5%; width: 35%; height: auto;
        }

        #floorPlan {
            width: 100%; height: auto; opacity: 0.8; border: 2px solid rgba(255,255,255,0.2);
        }

        #posisiAnda {
            position: absolute; width: 10%; height: auto; z-index: 10;
            animation: blink 1s infinite; display: none; filter: brightness(1.5) contrast(1.5);
        }

        /* FLOOR BUTTONS */
        .floor-controls {
            position: absolute; left: -170%; bottom: 0; 
            display: flex; flex-direction: column; gap: 0.5vh;
            pointer-events: auto;
        }

        .floor-btn {
            background-color: rgba(0, 255, 0, 0.15);
            border: 0.3vw solid rgba(0, 255, 0, 0.3);
            color: rgba(255, 255, 255, 0.9);
            padding: 0.5vw 1vw; font-size: 3vw;
            font-family: 'Courier New', Courier, monospace; font-weight: bold; font-size: 1em;
            cursor: pointer; text-align: center; width: 120%; transition: 0.2s;
        }
        .floor-btn:hover { background-color: rgba(0, 255, 0, 0.3); }
        .floor-btn.active-floor {
            border: 0.3vh solid #00ff00; background-color: rgba(0, 255, 0, 0.25);
            text-shadow: 0 0 5px #00ff00; box-shadow: 0 0 10px rgba(0, 255, 0, 0.1);
        }

        /* CAMERA BUTTONS */
        .cam-group { display: none; }
        .cam-group.show-group { display: block; } 

        .cam-btn {
            position: absolute; pointer-events: auto; 
            background-color: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.6);
            color: rgba(255, 255, 255, 0.8); padding: 2% 4%;
            font-family: 'Courier New', Courier, monospace; font-weight: bold; font-size: 0.6rem;
            cursor: pointer; text-transform: uppercase; text-shadow: 0 0 2px white;
            text-align: center; width: 37%;
        }
        .cam-btn:hover { background-color: rgba(255, 255, 255, 0.3); }
        .cam-btn.active {
            background-color: rgba(255, 255, 0, 0.3); border-color: rgba(255, 255, 0, 0.8);
            color: #ffff00; text-shadow: 0 0 5px yellow; box-shadow: 0 0 10px rgba(255, 255, 0, 0.2);
        }

        /* POSISI KAMERA LANTAI 3 */
        #camA { top: 70%; left: 10%; }
        #camB { top: 20%; left: 10%; }
        #camC { top: 20%; left: 70%; }
        /* POSISI KAMERA LANTAI 2 */
        #camD { top: 70%; left: 10%; } 
        #camE { top: 10%; left: 10%; } 
        #camF { top: 10%; left: 70%; } 
        /* POSISI KAMERA LANTAI 1 */
        #camG { top: 80%; left: 20%; }
        #camH { top: 15%; left: 15%; }
        #camI { top: 15%; left: 75%; }
        #camJ { top: 70%; left: 70%; }

        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        .hideCctv { transform: rotateX(110deg) translateY(20%); filter: blur(20px) brightness(0); opacity: 0; pointer-events: none; }
        .showCctv { transform: rotateX(0deg) translateY(-10%); filter: blur(0px) brightness(0.7); opacity: 1; }

        #startBtn {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.185); backdrop-filter: blur(5px); z-index: 99;
            display: flex; justify-content: center; align-items: center;
            color: white; font-size: 2.5rem; cursor: pointer; text-transform: uppercase; letter-spacing: 2px;
        }

        /* --- JUMPSCARE LAYER --- */
        #jumpscareLayer {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 5000; /* Di atas segalanya */
            pointer-events: none;
            display: none; /* Sembunyi default */
            overflow: hidden;
            background-color: transparent;
        }

        #jumpscareImg {
            position: absolute;
            height: 250%; /* Penuhi tinggi layar */
            width: auto;
            object-fit: cover;
            filter: contrast(1.2) brightness(0.8);
        }

        /* Kelas Saat Jumpscare Aktif */
        .jumpscare-active-Rustwalker #jumpscareImg {
            bottom: -120%;
            scale: 1;
            animation: 
                RustwalkerSlideInRight 0.2s forwards ease-out, /* Muncul cepat 0.2 detik */
                violentShake 0.3s infinite;         /* Gemetar terus menerus */
        }
        .jumpscare-active-TheRuin #jumpscareImg {
            bottom: -200%;
            scale: 1.6;
            animation: 
            TheRuinSlideInRight 0.2s forwards ease-out, /* Muncul cepat 0.2 detik */
                violentShake 0.3s infinite;         /* Gemetar terus menerus */
            }
            .jumpscare-active-TheJester #jumpscareImg {
                bottom: -176%;
                scale: 1.6;
                animation: 
                TheJesterSlideInRight 0.2s forwards ease-out, /* Muncul cepat 0.2 detik */
                violentShake 0.3s infinite;         /* Gemetar terus menerus */
            }
            .jumpscare-active-Rottenneck #jumpscareImg {
                bottom: -200%;
                right: 20%;
                scale: 1.4;
            animation: 
                RottenneckJumpscare 0.2s forwards ease-out, /* Muncul cepat 0.2 detik */
                violentShake 0.3s infinite;         /* Gemetar terus menerus */
        }

        /* --- JUMPSCARE KEYFRAMES --- */
        @keyframes RustwalkerSlideInRight {
            0% { right: -150%; opacity: 0; }
            100% { right: 10%; opacity: 1; }
        }
        @keyframes TheRuinSlideInRight {
            0% { right: -150%; opacity: 0; }
            100% { right: -45%; opacity: 1; }
        }
        @keyframes TheJesterSlideInRight {
            0% { right: 150%; opacity: 0; }
            100% { right: -7%; opacity: 1; }
        }
        
        @keyframes RottenneckJumpscare {
            0% { bottom: 80%; opacity: 0; }
            100% { bottom: 0%; opacity: 1; }
        }

        @keyframes DevourerJumpscare {
            0%{
                transform: scale(0);
                top: 50%;
                filter: brightness(0);
            }100%{
                top: 50%;
                transform: scale(2.0);
                filter: brightness(1);
            }
        }

        @keyframes violentShake {
            0% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(15px, 15px) rotate(2deg); }
            50% { transform: translate(-15px, 10px) rotate(-2deg); }
            75% { transform: translate(10px, -15px) rotate(1deg); }
            100% { transform: translate(-10px, -10px) rotate(-1deg); }
        }

        @keyframes strobeFlash {
            0% { filter: brightness(1) sepia(0) hue-rotate(0deg); }
            50% { filter: brightness(3) sepia(1) hue-rotate(-50deg) contrast(2); background-color: #300000; }
            100% { filter: brightness(0.5); }
        }
        /* enx5s */
        #devourerEntity.death{
            /* animation: DevourerJumpscare 2s forwards ease-out; */
            bottom: auto !important; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0); /* Mulai dari kecil/jauh */
            opacity: 1; 
            animation: devourerJumpscareAnim 9s forwards ease-out !important;
        }
                @keyframes devourerJumpscareAnim {
            0% { transform: translate(-50%, -90%) scale(0.1); filter: brightness(0); }
            24% {  filter: brightness(1);}
            70% { transform: translate(-50%, 1700%) scale(28.0); filter: brightness(1);}
            100% { transform: translate(-50%, 3400%) scale(50.0); filter: brightness(1);}
        }

        /* --- THE RUIN ENTITY --- */
     /* --- THE RUIN ENTITY --- */
        #theRuinEntity {
            position: absolute;
            z-index: 8; 
            display: none; 
            transform-origin: center center;
            pointer-events: none;
            
            width: 50%;  /* Sesuaikan lebar (misal 50% dari tinggi layar) */
            height: 80%; /* Sesuaikan tinggi (misal 80% dari tinggi layar) */
            
            /* Pusatkan container ini di titik koordinat (top/left) yang ditentukan JS */
            transform: translate(-50%, -50%);
        }

        #ruinWrapper {
            position: relative;
            width: 50%; height: 50%;
        }

        /* Bagian Tubuh & Kepala */
        #ruinBody, #ruinHead {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: auto;
            object-fit: contain;
        }

        /* Animasi Kepala (Sedikit bergoyang/floating) */
        #ruinHead {
            animation: ruinHeadMove 3s infinite ease-in-out;
        }

        @keyframes ruinHeadMove {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-2%) rotate(8deg); }
        }

        /* --- VIEWPORT EFFECT SAAT RUIN MUNCUL --- */
        /* Class ini akan ditambahkan ke #viewport lewat JS */
        .ruin-active-effect {
            animation: flikering 0.1s infinite alternate !important;
        }

        /* Animasi Flikering (Redup Nyala Cepat) */
        @keyframes flikering {
            0% { filter: brightness(0.1) hue-rotate(0deg) ; }
            100% { filter: brightness(0.8) hue-rotate(-20deg) ; }
        }

/* --- THE JESTER ELEMENTS (CCTV) --- */
        #cctvJesterWrapper {
            position: absolute;
            z-index: 4; 
            /* Ukuran default wrapper */
            width: 65%; left: 16.6%; top: 15%; aspect-ratio: 4/3; 
            pointer-events: none; 
            display: none; /* Sembunyi default */
            transform-origin: center center;
        }

        #jesterCctvBody, #jesterCctvHead {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: contain;
        }

        /* Animasi Kepala Jester (Sedikit miring-miring creepy) */
        #jesterCctvHead {
            animation: jesterHeadTwitch 4s infinite ease-in-out;
            transform-origin: center bottom; /* Poros di leher */
        }

        @keyframes jesterHeadTwitch {
            0%, 100% { transform: rotate(0deg); }
            10% { transform: rotate(5deg); }
            20% { transform: rotate(-3deg); }
            30% { transform: rotate(0deg); }
            60% { transform: rotate(0deg); }
            70% { transform: rotate(-8deg); }
            80% { transform: rotate(3deg); }
        }

        /* Helper untuk reset filter */
        .filter-reset {
            filter: saturate(1) hue-rotate(0deg);
        }

        /* --- ROTTENNECK ENTITY --- */
        #rottenneckEntity {
            position: absolute; 
            z-index: 9; /* Di atas dinding panorama, di bawah UI navigasi */
            width: 12%; /* Lebar relatif terhadap Main (300%), jadi sekitar 36% lebar layar viewport */
            height: auto;
            top: -120%; /* Posisi awal bersembunyi di atas plafon */
            transition: top 1.5s cubic-bezier(0.19, 1, 0.22, 1); /* Efek slide turun yang berat/menakutkan */
            pointer-events: none; display: none;
        }

        #rottenneckWrapper {
            position: relative;
            width: 100%;
            filter: brightness(0.6);
            animation: rottenneckIdle 1s infinite alternate;
        }

        #rottenneckHead {
            width: 100%;
            position: relative;
            z-index: 2;
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.8));
        }

        #rottenneckJaw {
            position: absolute;
            width: 90%; 
            left: 5%;
            top: 24%; /* Sesuaikan agar pas di bawah kepala */
            z-index: 1;
            transform-origin: top center; /* Engsel rahang di atas */
            animation: jawChatter 1s infinite alternate /* Animasi gigi gemeretuk */
        }

        /* Animasi Gigi Gemeretuk (Idle) */
        @keyframes jawChatter {
            0% { transform: translateY(1%) rotate(1deg); }
            100% { transform: translateY(-11%) rotate(-2deg); }
        }

        @keyframes rottenneckIdle {
            0%{
                transform: translateY(-3%);
            }
            100%{
                transform: translateY(2%);
            }
        }

        /* Class saat Teriak (Rahang terbuka lebar) */
        .jaw-scream {
            animation: none !important; /* Hentikan gemeretuk */
            transform: translateY(5%) rotate(0deg) !important; /* Buka lebar */
            transition: transform 0.2s ease-out;
        }

        /* --- DEATH SCREEN --- */
        #deathScreen {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: black;
            z-index: 9999;
            display: none; /* Hidden default */
            flex-direction: row;
            align-items: center;
            justify-content: center; /* Default tengah */
            overflow: hidden;
            color: white;
            transition: all 1s ease-in-out; /* Transisi layout */
        }

        /* Kilatan Merah */
        #deathFlash {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 10vw; height: 10vw;
            border-radius: 50%;
            box-shadow: 0 0 100vw 20vw rgba(255, 0, 0, 0);
            pointer-events: none;
            z-index: 1;
        }

        .red-flash-anim {
            animation: redFlash 0.6s ease-out forwards;
        }

        @keyframes redFlash {
            0% { box-shadow: 0 0 50vw 10vw rgba(200, 0, 0, 0.8); background-color: rgba(100,0,0,0.5); }
            100% { box-shadow: 0 0 100vw 20vw rgba(255, 0, 0, 0); background-color: transparent; }
        }

        /* Content Text */
        #deathContent {
            z-index: 10;
            text-align: center;
            opacity: 0; /* Muncul setelah flash */
            transition: all 1s ease;
            width: 80%;
            max-width: 800px;
        }

        #deathTitle {
            font-size: 5vw; color: #cc0000; text-shadow: 0 0 10px #550000; margin-bottom: 2vh;
            text-transform: uppercase; letter-spacing: 5px;
        }
        #deathSubtitle {
            font-size: 2.7vw; color: #ddd; margin-bottom: 3vh;
        }
        #deathTip {
            font-size: 1.8vw; color: #888; font-style: italic; border-top: 1px solid #333; padding-top: 2vh;
        }

        /* Stats & Button (Hidden in Phase 1) */
        #deathStats {
            margin-top: 4vh; font-size: 2vw;
            opacity: 0;
            transition: opacity 1s ease;
            pointer-events: none; /* Biar ga bisa diklik sblm muncul */
        }

        #retryBtn {
            background: transparent; border: 0.4vw solid #cc0000; color: #cc0000;
            padding: 5% 15%; font-size: 1.5rem; font-family: inherit; font-weight: bold;
            cursor: pointer; transition: 0.3s; margin-top: 5%;
        }
        #retryBtn:hover { background: #cc0000; color: black; box-shadow: 0 0 20px red; }

        /* Gambar Entitas (Kiri) */
        #deathEntityBox {
            position: absolute; left: 5%; bottom: 0; height: 90%;
            opacity: 0; transform: translateX(-50px);
            transition: all 1.5s ease;
            z-index: 5;
        }
        #deathEntityImg {
            height: auto; width: 60%; object-fit: contain; transform: translateY(-15%);
            filter: drop-shadow(0 0 20px rgba(0,0,0,0.8));
        }

        /* --- PHASE 2 STATE (Rata Kanan) --- */
        #deathScreen.phase-2 {
            justify-content: flex-end; /* Pindah ke kanan */
        }
        
        #deathScreen.phase-2 #deathContent {
            text-align: right;
            margin-right: 5%;
            width: 45%; /* Sempitkan area teks */
        }

        #deathScreen.phase-2 #deathEntityBox {
            opacity: 1;
            transform: translateX(0);
        }

        #deathScreen.phase-2 #deathStats {
            opacity: 1;
            pointer-events: auto;
        }
        /* --- PANEL VIEW LAYER --- */
        #panelViewLayer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 55; /* Di atas Main(0-10) & Nav(10), di bawah UI(60) */
            background-color: #000;
            display: none; /* Hidden default */
        }

        #panelViewImg {
            width: 100%; height: 100%;
            object-fit: cover;
        }

        #panelControls {
            position: absolute; width: 100%; height: 100%; top: 0; left: 0;
            pointer-events: none; /* Container tembus klik */
        }

        .panel-hud-btn {
            position: absolute; pointer-events: auto;
            background: rgba(0, 0, 0, 0.6); border: 0.2vh solid white;
            color: white; padding: 1% 2%; font-family: 'Courier New', Courier, monospace;
            font-weight: bold; cursor: pointer; text-align: center;
            transition: 0.2s;
        }
        .panel-hud-btn:hover { background: white; color: black; }

        /* Posisi Tombol Kontrol */
        #panelLeftBtn { bottom: 5%; left: 5%; width: 20%; }
        #PanelActivationBtn { bottom: 15%; left: 5%; width: 20%; background-color: rgba(0, 149, 255, 0.459); border:  0.2vh solid rgba(0, 36, 62, 0.756);}
        #PanelActivationBtn:hover { background: rgba(0, 36, 62, 0.756); color: white;}
        #panelCenterBtn { bottom: 40%; left: 50%; transform: translateX(-50%); width: 20%; }

        /* --- TOMBOL TRIGGER DI PANORAMA (Merah) --- */
        .panel-trigger-btn {
            background-color: rgba(200, 0, 0, 0.3) !important;
            border-color: rgba(255, 0, 0, 0.5) !important;
            color: #ffcccc !important;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.4) !important;
        }
        .panel-trigger-btn:hover {
            background-color: rgba(255, 0, 0, 0.6) !important;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.8) !important;
        }
        /* --- MINIGAME LAYER --- */
        #minigameLayer {
            position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 60%; height: 50%; /* Ukuran "jendela" minigame */
            background-color: black;
            border: 0.3vh solid white;
            z-index: 58; /* Di atas Panel View (55), di bawah UI (60) */
            display: none;
            flex-direction: column;
            padding: 2%;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
        }

        #minigameHeader {
            display: flex; justify-content: space-between;
            color: white; font-family: 'Courier New', Courier, monospace;
            font-weight: bold; border-bottom: 1px solid #555;
            padding-bottom: 1%; margin-bottom: 2%;
            font-size: 2vh;
        }

        #minigameMessage {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #00ff00; font-size: 4vh; font-weight: bold;
            text-shadow: 0 0 10px #00ff00; display: none; z-index: 80;
            font-family: 'Courier New', Courier, monospace;
            background: rgba(0,0,0,0.9); padding: 10%; border: 1px solid #00ff00;
        }

        /* --- MEMORY CARD GRID --- */
        #memoryBoard {
            display: grid;
            gap: 2%;
            width: 100%; height: 100%;
            justify-content: center; align-content: center;
        }

        .memory-card {
            background-color: #111;
            border: 0.2vh solid #0088ff; /* Border Biru sesuai request */
            display: flex; justify-content: center; align-items: center;
            font-size: 5vh; 
            cursor: pointer;
            user-select: none;
            transition: transform 0.1s, background-color 0.2s;
        }

        .memory-card:hover { background-color: #222; }
        
        /* Kartu Terbuka */
        .memory-card.flipped {
            background-color: #ddd;
            border-color: white;
        }

        /* Kartu Cocok (Matched) */
        .memory-card.matched {
            border-color: #00ff00;
            box-shadow: 0 0 10px #00ff00;
            opacity: 0.7; pointer-events: none;
        }

        /* --- TIMING GAME COMPONENTS --- */
        #minigameArea {
            width: 100%;
            height: 90%; /* Mengisi sisa ruang setelah header */
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        #timingBarContainer {
            position: relative;
            width: 90%;
            height: 10vh; /* Tinggi bar yang responsif */
            background-color: #333;
            border: 2px solid #555;
            margin-bottom: 5vh;
            overflow: hidden;
        }

/* Garis Merah (Dinamis) */
#redLine {
    position: absolute;
    top: 0; left: 0;
    width: 1%; 
    height: 100%;
    background-color: red;
    box-shadow: 0 0 5px red;
    z-index: 5; 
}

        /* Zona Hit (Garis Kuning) */
        #hitZones {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
        }

        .hit-zone {
            position: absolute;
            height: 100%;
            background-color: rgba(255, 255, 0, 0.4); /* Kuning transparan */
            border-left: 1px solid yellow;
            border-right: 1px solid yellow;
        }

      #timingHitBtn {
    font-family: 'Courier New', Courier, monospace;
    padding: 1.5vh 5vh;
    font-size: 2.5vh;
    background-color: #cc0000;
    color: white;
    border: 2px solid #ff5555;
    cursor: pointer; display: none;
    transition: background-color 0.2s;
    margin-top: 3vh; /* Tambahkan jarak dari bar */
    z-index: 10;     /* Pastikan bisa diklik */
}

        #timingHitBtn:hover {
            background-color: #ff0000;
            box-shadow: 0 0 10px red;
        }

        /* --- DISPLAY CONTEXT --- */
        /* Pastikan hanya satu minigame yang tampil */
        #minigameLayer[data-type="memory"] #timingBarContainer,
        #minigameLayer[data-type="timing"] #memoryBoard {
            display: none;
        }
        #minigameLayer[data-type="timing"] #timingBarContainer {
            display: block;
        }
        #minigameLayer[data-type="memory"] #memoryBoard {
            display: grid; /* Gunakan display Memory Card sebelumnya */
        }
        #notification{
            pointer-events: none; position: absolute; left: 50%; transition: 1.2s;
            transform: translateX(-50%); width: auto; padding: 0.5%; font-weight: 500;
            background-color: rgba(10, 10, 10, 0.413); font-size: 1.6vw; z-index: 101;
            color: rgba(255, 255, 255, 0.68); text-align: center; font-family: monospace;
        }
        #notification.note-active {top: 2%;}
        #notification.note-inactive {top: -12%;}
        /* --- DEVOURER ENTITY --- */
        #devourerEntity {
            position: absolute;
            z-index: 1000; 
            width: 20%; /* Sesuaikan ukuran */
            height: auto;
            pointer-events: none;
            display: none; /* Sembunyi default */
            transform-origin: center bottom;
        }

        #devourerWrapper {
            position: relative; width: 100%; height: 100%;
        }

        #devourerHead {
            position: absolute; top: -10%; left: 10%; width: 80%; z-index: 2;
        }

        #devourerBody {
            position: relative; width: 100%; z-index: 1;
            /* Animasi Getar Cepat (Lari/Agresif) */
            animation: devourerShake 0.1s infinite alternate; 
        }

        @keyframes devourerShake {
            0% { transform: translateY(5%); }
            100% { transform: translateY(-5%); }
        }

        /* --- TOILET LAYER --- */
        #toiletLayer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 56; /* Di atas Panel(55), di bawah Minigame(58) & UI(60) */
            background: black;
            display: none;
        }
        
        #toiletViewImg {
            width: 100%; height: 100%; object-fit: cover;
            filter: brightness(0.4); /* Gelap di dalam toilet */
        }

        #toiletControls {
            position: absolute; bottom: 10%; left: 50%; transform: translateX(-50%);
            width: 100%; text-align: center;
        }

        #btnExitToilet {
            display: inline-block; padding: 1% 3%;
            background: rgba(0,0,0,0.7); border: 2px solid #555; color: #ddd;
            cursor: pointer; font-family: 'Courier New', monospace; font-weight: bold;
            transition: 0.3s;
        }
        #btnExitToilet:hover { background: #333; color: white; border-color: white; }

        /* Tombol Masuk Toilet (di Panorama) */
        .toilet-entry-btn {
            background-color: rgba(0, 255, 100, 0.2) !important;
            border-color: rgba(0, 255, 100, 0.5) !important;
            color: #ccffcc !important;
        }
        .toilet-entry-btn:hover {
            background-color: rgba(0, 255, 100, 0.5) !important;
        }

/* --- WINNING SCREEN --- */
        #winningScreen {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: black;
            z-index: 10000; /* Di atas Death Screen */
            display: none; /* Hidden default */
            justify-content: center; align-items: center;
            overflow: hidden; opacity: 0;
            transition: opacity 2s ease-in-out; /* Fade In Perlahan */
        }

        #winningBgImg {
            position: absolute; top: -5%; left: -5%; width: 110%; height: 110%;
            object-fit: cover; opacity: 0.8;
            animation: winningBgAnim 8s infinite ease-in-out alternate;
        }

        @keyframes winningBgAnim {
            0% { transform: translateY(0) scale(1); filter: brightness(0.6); }
            100% { transform: translateY(-2%) scale(1.02); filter: brightness(1.0); }
        }

        #winningOverlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(5px);
            z-index: 1;
        }

        #winningContent {
            position: relative; z-index: 2;
            text-align: center; color: white;
            font-family: 'Courier New', Courier, monospace;
            background: rgba(0, 0, 0, 0.167);
            padding: 4vw; border: 2px solid rgba(255, 255, 255, 0.082);
            width: 70%; max-width: 800px;
        }

        #winningTitle {
            font-size: 5vw; margin-bottom: 2vw;
            color: #44ff44; text-shadow: 0 0 15px #008800;
            min-height: 1.2em; /* Mencegah layout jump saat ngetik */
        }

        #winningSubtitle {
            font-size: 2vw; margin-bottom: 4vh; color: #ddd;
            min-height: 1.2em;
        }

        #winningStats {
            font-size: 1.5vw; color: #aaa; margin-bottom: 5vh;
            border-top: 1px solid #555; padding-top: 2vh;
            opacity: 0; transition: opacity 1s;
        }

        #winningButtons {
            display: flex; justify-content: center; gap: 20px;
            opacity: 0; transition: opacity 1s; pointer-events: none;
        }

        #winningButtons button {
            background: transparent; border: 2px solid #44ff44; color: #44ff44;
            padding: 15px 30px; font-size: 1.2rem; font-family: inherit; font-weight: bold;
            cursor: pointer; transition: 0.3s;
        }
        #winningButtons button:hover {
            background: #44ff44; color: black; box-shadow: 0 0 20px #00ff00;
        }
        #winMenuBtn { border-color: white; color: white; }
        #winMenuBtn:hover { background: white; color: black; box-shadow: 0 0 20px white; }


    </style>
</head>
<!-- HTML: code: htmlx -->
<body>
    <div id="loading-screen">
        <div id="preRenderingIMGwrapper"></div>
         <div class="loader-content">
            <h2 id="loadingTitle">Santai ae dlu, lagi Memuat Aset...</h2>
            <div class="progress-container">
                <div id="progress-bar"></div>
            </div>
            <p id="progress-text">0%</p>
        </div>
    </div>

    <audio id="bgAudio" loop><source src="./assets/audio/MainBgmHorror.mp3" type="audio/mpeg"></audio>
    <audio id="btnSfx"><source src="./assets/audio/mechanicalswish.mp3" type="audio/mpeg"></audio>
    <audio id="cctvStatic" loop><source src="./assets/audio/ConstantStaticTv.mp3" type="audio/mpeg"></audio>
    <audio id="monitorOnSfx"><source src="./assets/audio/cassette-sfx.mp3" type="audio/mpeg"></audio>
    <audio id="camSwitchSfx"><source src="./assets/audio/beep.mp3" type="audio/mpeg"></audio>
    <audio id="footstepPlayerSfx"><source src="./assets/audio/playerRunSfx.mp3" type="audio/mpeg"></audio>
    <audio id="newAreaSfx"><source src="./assets/audio/sfxNewArea.mp3" type="audio/mpeg"></audio>
    <audio id="cctvErrorSfx"><source src="./assets/audio/staticTV.mp3" type="audio/mpeg"></audio>
    <audio id="jumpscare1Sfx"><source src="./assets/audio/jumpscare1sfx.mp3" type="audio/mpeg"></audio>
    <audio id="theRuinSfx"><source src="./assets/audio/theRuinSfx.mp3" type="audio/mpeg"></audio>
    <audio id="theRuinPreSfx"><source src="./assets/audio/randomHorrorSound.mp3" type="audio/mpeg"></audio>
    <audio id="thejesterMusicBoxSfx"><source src="./assets/audio/theJesterPassive.mp3" type="audio/mpeg"></audio>
    <audio id="thejesterHuntSfx"><source src="./assets/audio/theJesterHuntSFX.mp3" type="audio/mpeg"></audio>
    <audio id="thejesterScream"><source src="./assets/audio/theJesterScreamCaught.mp3" type="audio/mpeg"></audio>
    <audio id="thejesterPursuing"><source src="./assets/audio/theJesterPursuing.mp3" type="audio/mpeg"></audio>
    <audio id="thejesterRUN"><source src="./assets/audio/theJesterRUN.mp3" type="audio/mpeg"></audio>
    <audio id="deathScreenMusic"><source src="./assets/audio/deathmusic.mp3" type="audio/mpeg"></audio>
    <audio id="openElectricalPanel"><source src="./assets/audio/openElectricalPanelSFX.mp3" type="audio/mpeg"></audio>
    <audio id="closeElectricalPanel"><source src="./assets/audio/closeElectricalPanelSFX.mp3" type="audio/mpeg"></audio>
    <audio id="minigamePanelClickSfx"><source src="./assets/audio/beep-313342.mp3" type="audio/mpeg"></audio>
    <audio id="correctSfx"><source src="./assets/audio/correct-356013.mp3" type="audio/mpeg"></audio>
    <audio id="incorrectSfx"><source src="./assets/audio/incorrect-293358.mp3" type="audio/mpeg"></audio>
    <audio id="completeSfx"><source src="./assets/audio/activationSucceed.mp3" type="audio/mpeg"></audio>
    <audio id="rottenneckSFX"><source src="./assets/audio/rottenneckSFX.mp3" type="audio/mpeg"></audio>
    <audio id="rottenneckScreamSFX"><source src="./assets/audio/rottenneckScreamSFX.mp3" type="audio/mpeg"></audio>
    <audio id="devourerAppearanceSFX"><source src="./assets/audio/devourerAppearanceSFX.mp3" type="audio/mpeg"></audio>
    <audio id="devourerAmbientSFX"><source src="./assets/audio/devourerAmbientSFX.mp3" type="audio/mpeg"></audio>
    <audio id="devourerScreamSFX"><source src="./assets/audio/devourerScreamSFX.mp3" type="audio/mpeg"></audio>
    <audio id="winningMusic"><source src="./assets/audio/winningMusic.mp3" type="audio/mpeg"></audio>
    <audio id="keyboardSfx"><source src="./assets/audio/keyboardSFX.mp3" type="audio/mpeg"></audio>

    <div id="deathScreen">
        <div id="deathFlash"></div>

        <div id="deathEntityBox">
            <img src="" id="deathEntityImg" alt="Killer">
        </div>

        <div id="deathContent">
            <h1 id="deathTitle">KAMU TEWAS</h1>
            <h2 id="deathSubtitle">TERTANGKAP OLEH...</h2>
            <p id="deathTip">Tips counter disini...</p>
            
            <div id="deathStats">
                <p id="deathTime">SURVIVED UNTIL: 00:00</p>
                <button id="retryBtn">ULANGI MALAM INI</button>
            </div>
        </div>
    </div>

    <div id="winningScreen">
        <img src="./assets/image/wining.png" id="winningBgImg" alt="Victory">
        
        <div id="winningOverlay"></div>

        <div id="winningContent">
            <h1 id="winningTitle"></h1>
            <h2 id="winningSubtitle"></h2>
            
            <div id="winningStats">
                <p id="winGameTime">WAKTU GAME SELESAI: --:--</p>
                </div>

            <div id="winningButtons">
                <button id="winRetryBtn">ULANGI MALAM</button>
                <button id="winMenuBtn">KEMBALI KE MENU</button>
            </div>
        </div>
    </div>

    <div id="viewport">
        <div id="transitionOverlay"></div>
        <div id="jumpscareLayer">
            <img src="./assets/image/M1/entity/RustwalkerStatic.png" id="jumpscareImg" alt="JUMPSCARE">
        </div>

       <div id="main">
            <img src="./assets/image/M1/panoramaSectionA1.png" id="mainImg1" class="main-img">
            <img src="./assets/image/M1/panoramaSectionA2.png" id="mainImg2" class="main-img">
            <img src="./assets/image/M1/panoramaSectionA3.png" id="mainImg3" class="main-img">
            <!-- tombol navigasi antartitik player-->
            <div id="navLayer" style="position: absolute; top:0; left:0; width: 100%; height: 100%; z-index: 10;"></div>
                
            <div id="theRuinEntity">
                <div id="ruinWrapper">
                    <img src="./assets/image/M1/entity/theRuinBody.png" id="ruinBody" alt="Ruin Body">
                    <img src="./assets/image/M1/entity/theRuinHead.png" id="ruinHead" alt="Ruin Head">
                </div>
            </div>

            <!-- ENTITY 04: ROTTENNECK -->
            <div id="rottenneckEntity">
                <div id="rottenneckWrapper">
                    <img src="./assets/image/M1/entity/rottenneckHEAD.png" id="rottenneckHead" alt="Head">
                    <img src="./assets/image/M1/entity/rottenneckJAW.png" id="rottenneckJaw" alt="Jaw">
                </div>
            </div>

            <div id="devourerEntity">
                <div id="devourerWrapper">
                    <img src="./assets/image/M1/entity/devourerBody.png" id="devourerBody" alt="Body">
                    <img src="./assets/image/M1/entity/devourerHead.png" id="devourerHead" alt="Head">
                </div>
            </div>

        </div>

        <div id="viewLeftBox" class="viewSide"></div>
        <div id="viewRightBox" class="viewSide"></div>
        <div id="panelViewLayer">
           
            <img src="" id="panelViewImg"> 
            
            <div id="panelControls">
                <div id="panelLeftBtn" class="panel-hud-btn">KEMBALI</div>
                <div id="panelCenterBtn" class="panel-hud-btn">BUKA PANEL</div>
                <div id="PanelActivationBtn" class="panel-hud-btn">AKTIFASI PANEL</div>
            </div>
        </div>
        <div id="minigameLayer">
            <div id="minigameHeader">
                <span id="minigameTitle">SYSTEM OVERRIDE</span>
                <span id="minigameProgress">LEVEL 1/10</span>
            </div>
            
            <div id="minigameArea">
                <div id="timingBarContainer">
                    <div id="redLine"></div>
                    <div id="hitZones"></div>
                </div>
                
                <button id="timingHitBtn">HIT</button>
                
                <div id="memoryBoard"></div>
            </div>

            <div id="minigameMessage">SYSTEM RESTORED</div>
        </div>

        <div id="toiletLayer">
            <img src="./assets/image/M1/toilet.png" id="toiletViewImg" alt="Inside Toilet">
            
            <div id="toiletControls">
                <div id="btnExitToilet">KELUAR</div>
            </div>
        </div>

        <div id="UI">
            <div id="notification" class="note-inactive"></div>
            <div id="cctvContainer">
                <div id="monitorWrapper" class="hideCctv">
                    <img src="./assets/image/komp.png" id="cctvFrame">
                    <img src="./assets/image/M1/cctv/cameraSectionA.png" id="cctvScreen">
                    <img src="./assets/image/M1/entity/entityOnCCTVRustwalker.png" alt="" id="cctvEntityRustwalkerDisplay">
                    <div id="cctvJesterWrapper">
                        <img src="./assets/image/M1/entity/theJesterBody.png" id="jesterCctvBody">
                        <img src="./assets/image/M1/entity/theJesterHead.png" id="jesterCctvHead">
                    </div>
                    <div id="cctvUiLayer">
                        <div id="cctvNavbar">00:00</div> 
                        
                        <div id="mapContainer">
                            <img src="./assets/image/M1/cctv/DenahLantai3.png" id="floorPlan">
                            <img src="./assets/image/M1/cctv/PosisiAnda.png" id="posisiAnda">
                            
                            <div id="floor3Group" class="cam-group show-group">
                                <div id="camA" class="cam-btn active" data-cam="A">CAM A</div>
                                <div id="camB" class="cam-btn" data-cam="B">CAM B</div>
                                <div id="camC" class="cam-btn" data-cam="C">CAM C</div>
                            </div>
                            <div id="floor2Group" class="cam-group">
                                <div id="camD" class="cam-btn" data-cam="D">CAM D</div>
                                <div id="camE" class="cam-btn" data-cam="E">CAM E</div>
                                <div id="camF" class="cam-btn" data-cam="F">CAM F</div>
                            </div>
                            <div id="floor1Group" class="cam-group">
                                <div id="camG" class="cam-btn" data-cam="G">CAM G</div>
                                <div id="camH" class="cam-btn" data-cam="H">CAM H</div>
                                <div id="camI" class="cam-btn" data-cam="I">CAM I</div>
                                <div id="camJ" class="cam-btn" data-cam="J">CAM J</div>
                            </div>

                            <div class="floor-controls">
                                <div class="floor-btn active-floor" data-floor="3">FLOOR 3</div>
                                <div class="floor-btn" data-floor="2">FLOOR 2</div>
                                <div class="floor-btn" data-floor="1">FLOOR 1</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="cctvBtn">â–²</div>
        </div>

        <div id="startBtn">Ketuk Untuk Memulai</div>
    </div>

    <script>
        
        // --- ELEMENTS ---
        const startBtn = document.getElementById('startBtn');
        const cctvBtn = document.getElementById('cctvBtn');
        const monitorWrapper = document.getElementById('monitorWrapper'); 
        const cctvScreen = document.getElementById('cctvScreen');         
        const cctvFrame = document.getElementById('cctvFrame');
        const cctvUiLayer = document.getElementById('cctvUiLayer'); 
        const cctvNavbar = document.getElementById('cctvNavbar');
        const mainContainer = document.getElementById('main');
        const leftZone = document.getElementById('viewLeftBox');
        const rightZone = document.getElementById('viewRightBox');
        const floorPlan = document.getElementById('floorPlan');
        const posisiAnda = document.getElementById('posisiAnda');
        const moveBtn = document.getElementById('moveBtn');
        const transitionOverlay = document.getElementById('transitionOverlay');
        const navLayer = document.getElementById('navLayer');
        
        const mainImg1 = document.getElementById('mainImg1');
        const mainImg2 = document.getElementById('mainImg2');
        const mainImg3 = document.getElementById('mainImg3');

        const camBtns = document.querySelectorAll('.cam-btn');
        const floorBtns = document.querySelectorAll('.floor-btn');
        const camGroups = {
            3: document.getElementById('floor3Group'),
            2: document.getElementById('floor2Group'),
            1: document.getElementById('floor1Group')
        };

        // --- LOADING SCREEN ---
    document.addEventListener("DOMContentLoaded", () => {
        const loadingScreen = document.getElementById('loading-screen');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const loadingTitle = document.getElementById('loadingTitle');
        const preRenderingIMGwrapper = document.getElementById('preRenderingIMGwrapper');
        

        function renderDisplayNoneAssets(){
            let preRenderingIMGfile =[
                './assets/image/M1/cctv/cameraSectionA.png',
                './assets/image/M1/cctv/cameraSectionB.png',
                './assets/image/M1/cctv/cameraSectionC.png',
                './assets/image/M1/cctv/cameraSectionD.png',
                './assets/image/M1/cctv/cameraSectionE.png',
                './assets/image/M1/cctv/cameraSectionF.png',
                './assets/image/M1/cctv/cameraSectionG.png',
                './assets/image/M1/cctv/cameraSectionH.png',
                './assets/image/M1/cctv/cameraSectionI.png',
                './assets/image/M1/cctv/cameraSectionJ.png',
                './assets/image/M1/panoramaSectionA1.png',
                './assets/image/M1/panoramaSectionA2.png',
                './assets/image/M1/panoramaSectionA3.png',
                './assets/image/M1/panoramaSectionB1.png',
                './assets/image/M1/panoramaSectionB2.png',
                './assets/image/M1/panoramaSectionB3.png',
                './assets/image/M1/panoramaSectionC1.png',
                './assets/image/M1/panoramaSectionC2.png',
                './assets/image/M1/panoramaSectionC3.png',
                './assets/image/M1/panoramaSectionD1.png',
                './assets/image/M1/panoramaSectionD2.png',
                './assets/image/M1/panoramaSectionD3.png',
                './assets/image/M1/panoramaSectionE1.png',
                './assets/image/M1/panoramaSectionE2.png',
                './assets/image/M1/panoramaSectionE3.png',
                './assets/image/M1/panoramaSectionF1.png',
                './assets/image/M1/panoramaSectionF2.png',
                './assets/image/M1/panoramaSectionF3.png',
                './assets/image/M1/panoramaSectionG1.png',
                './assets/image/M1/panoramaSectionG2.png',
                './assets/image/M1/panoramaSectionG3.png',
                './assets/image/M1/panoramaSectionH1.png',
                './assets/image/M1/panoramaSectionH2.png',
                './assets/image/M1/panoramaSectionH3.png',
                './assets/image/M1/panoramaSectionI1.png',
                './assets/image/M1/panoramaSectionI2.png',
                './assets/image/M1/panoramaSectionI3.png',
                './assets/image/M1/panoramaSectionJ1.png',
                './assets/image/M1/panoramaSectionJ2.png',
                './assets/image/M1/panoramaSectionJ3.png',
                './assets/image/M1/panel/ClosedElectricalPanelSectionA.png',
                './assets/image/M1/panel/OpenedElectricalPanelSectionA.png',
                './assets/image/M1/panel/ClosedElectricalPanelSectionD.png',
                './assets/image/M1/panel/OpenedElectricalPanelSectionD.png',
                './assets/image/M1/panel/ClosedElectricalPanelSectionH.png',
                './assets/image/M1/panel/OpenedElectricalPanelSectionH.png',
                './assets/image/M1/panel/ClosedElectricalPanelSectionI.png',
                './assets/image/M1/panel/OpenedElectricalPanelSectionI.png',
                "./assets/image/M1/entity/theRuinHead.png",
                "./assets/image/M1/entity/theRuinBody.png",
                "./assets/image/M1/entity/theJesterHead.png",
                "./assets/image/M1/entity/theJesterBody.png",
                "./assets/image/M1/entity/rottenneckHEAD.png",
                "./assets/image/M1/entity/rottenneckJAW.png",
                "./assets/image/M1/entity/RustwalkerStatic.png",
                "./assets/image/M1/entity/devourerBody.png",
                "./assets/image/M1/entity/devourerHead.png",
                "./assets/image/M1/cctv/DenahLantai3.png",
                "./assets/image/M1/cctv/DenahLantai2.png",
                "./assets/image/M1/cctv/DenahLantai1.png",
                "./assets/image/M1/cctv/PosisiAnda.png",
                "./assets/image/M1/entity/entityOnCCTVRustwalker.png",
                "./assets/image/M1/toilet.png"
            ]
            preRenderingIMGfile.forEach(source => {
                preRenderingIMGwrapper.innerHTML+=`<img src='${source}'>`
            });
        }

        renderDisplayNoneAssets()

        const mediaAssets = document.querySelectorAll('img, video, audio');
        let totalAssets = mediaAssets.length;
        let assetsLoaded = 0;

        function updateProgress() {
            assetsLoaded++;
            const percent = Math.round((assetsLoaded / totalAssets) * 100);
            progressBar.style.width = percent + '%';
            progressText.textContent = percent + '%';

            if(assetsLoaded >= totalAssets) {
                finishLoading();
            }

        }

        function finishLoading() {
            progressBar.style.background ="#73ff57"
            progressText.style.color ='#73ff57'
            loadingTitle.style.color ='#73ff57'
            preRenderingIMGwrapper.remove()
            loadingTitle.innerHTML =`sip, asset berhasil dimuat ðŸ—¿ðŸ‘ðŸ»`
            setTimeout(() => {
                loadingScreen.classList.add('hide');
            }, 1500);
        }

        if (totalAssets === 0) {
            finishLoading();
        } else {
            mediaAssets.forEach((asset) => {
                if (asset.complete || asset.readyState === 4) {
                    updateProgress();
                } else {
                    if (asset.tagName === 'IMG') {
                        asset.addEventListener('load', updateProgress);
                        asset.addEventListener('error', updateProgress); 
                    } 
                    else {
                        asset.addEventListener('canplaythrough', updateProgress, { once: true });
                        asset.addEventListener('error', updateProgress);
                    }
                }
            });
        }

        // SAFETY NET 
        window.addEventListener('load', () => {
            if (assetsLoaded < totalAssets) {
                progressBar.style.width = '100%';
                progressText.textContent = '100%';
                finishLoading();
            }
        });
    });

    // document.addEventListener("contextmenu",(e)=>{e.preventDefault(); return false})

        // --- AUDIO --- code: aux
        const bgAudio = document.getElementById('bgAudio');
        const btnSfx = document.getElementById('btnSfx');
        const cctvStatic = document.getElementById('cctvStatic');
        const monitorOnSfx = document.getElementById('monitorOnSfx');
        const camSwitchSfx = document.getElementById('camSwitchSfx');
        const footstepPlayerSfx = document.getElementById('footstepPlayerSfx');
        const newAreaSfx = document.getElementById('newAreaSfx');
        const cctvErrorSfx = document.getElementById('cctvErrorSfx');
        const jumpscare1Sfx = document.getElementById('jumpscare1Sfx');
        const theRuinSfx = document.getElementById('theRuinSfx');
        const theRuinPreSfx = document.getElementById('theRuinPreSfx');
        const thejesterMusicBoxSfx = document.getElementById('thejesterMusicBoxSfx');
        const thejesterHuntSfx = document.getElementById('thejesterHuntSfx');
        const thejesterScream = document.getElementById('thejesterScream');
        const thejesterPursuing = document.getElementById('thejesterPursuing');
        const thejesterRUN= document.getElementById('thejesterRUN');
        const deathScreenMusic = document.getElementById('deathScreenMusic');
        const openElectricalPanel= document.getElementById('openElectricalPanel');
        const closeElectricalPanel = document.getElementById('closeElectricalPanel');
        const correctSfx = document.getElementById('correctSfx');
        const incorrectSfx = document.getElementById('incorrectSfx');
        const completeSfx = document.getElementById('completeSfx');
        const minigamePanelClickSfx = document.getElementById('minigamePanelClickSfx');
        const rottenneckSFX = document.getElementById('rottenneckSFX');
        const rottenneckScreamSFX = document.getElementById('rottenneckScreamSFX');
        const devourerAppearanceSFX = document.getElementById('devourerAppearanceSFX');
        const devourerAmbientSFX = document.getElementById('devourerAmbientSFX');
        const devourerScreamSFX = document.getElementById('devourerScreamSFX');
        const winningMusic = document.getElementById('winningMusic');
        const keyboardSfx = document.getElementById('keyboardSfx');

        bgAudio.volume = 0.8; btnSfx.volume = 0.3; cctvStatic.volume = 0.5; monitorOnSfx.volume = 1.0;
        footstepPlayerSfx.volume = 1.0; newAreaSfx.volume = 1.0; camSwitchSfx.volume = 0.3;  
        cctvErrorSfx.volume = 0.8; jumpscare1Sfx.volume = 0.8; theRuinSfx.volume = 1.0; theRuinPreSfx.volume = 1.0;
        thejesterHuntSfx.volume = 1.0; thejesterMusicBoxSfx.volume = 0.4; thejesterScream.volume = 0.9;
        thejesterPursuing.volume = 1.0; thejesterRUN.volume = 0; deathScreenMusic.volume = 1.0; devourerAmbientSFX.volume =1.0;
        openElectricalPanel.volume = 1.0; closeElectricalPanel.volume = 1.0; completeSfx.volume = 1.0;
        minigamePanelClickSfx.volume = 1.0; correctSfx.volume = 1.0; incorrectSfx.volume = 1.0; devourerScreamSFX.volume = 1.0;
        rottenneckSFX.volume = 1.0; rottenneckScreamSFX.volume = 1.0; devourerAppearanceSFX.volume = 1.0;
        winningMusic.volume = 1.0; keyboardSfx.volume = 1.0;

        // --- DATABASE CONFIG ---
        
        const cameraData = {
            'A': './assets/image/M1/cctv/cameraSectionA.png',
            'B': './assets/image/M1/cctv/cameraSectionB.png', 
            'C': './assets/image/M1/cctv/cameraSectionC.png',
            'D': './assets/image/M1/cctv/cameraSectionD.png',
            'E': './assets/image/M1/cctv/cameraSectionE.png',
            'F': './assets/image/M1/cctv/cameraSectionF.png',
            'G': './assets/image/M1/cctv/cameraSectionG.png',
            'H': './assets/image/M1/cctv/cameraSectionH.png',
            'I': './assets/image/M1/cctv/cameraSectionI.png',
            'J': './assets/image/M1/cctv/cameraSectionJ.png'

            
        };

        const floorData = {
            3: './assets/image/M1/cctv/DenahLantai3.png',
            2: './assets/image/M1/cctv/DenahLantai2.png', 
            1: './assets/image/M1/cctv/DenahLantai1.png'  
        };

        // DATA PANORAMA (TITIK LOKASI) code: ldx
        const locationData = {
            // --- LANTAI 3 ---
            'A': {
                images: [
                    './assets/image/M1/panoramaSectionA1.png',
                    './assets/image/M1/panoramaSectionA2.png',
                    './assets/image/M1/panoramaSectionA3.png'
                ],
                buttons: [
                    { target: 'B', text: 'AREA B', css: { left: '50.8%', top: '50%' } },
                    { target: 'C', text: 'AREA C', css: { left: '65.5%', top: '50%' } },
                    { target: 'D', text: 'TURUN KE LT.2 (AREA D)', css: { left: '80%', top: '80%' } }
                ],
                panels: [
                    {
                        id: 'panelA',
                        text: 'PANEL A',
                        css: { left: '20%', top: '25%' }, // Posisi di Panorama (Sesuaikan nanti)
                        imgClosed: './assets/image/M1/panel/ClosedElectricalPanelSectionA.png',
                        imgOpened: './assets/image/M1/panel/OpenedElectricalPanelSectionA.png'
                    }
                ],
                playerData: { floor: 3, cam: 'A', mapCss: { top: '75%', left: '22%' } }
            },
            'B': {
                images: [
                    './assets/image/M1/panoramaSectionB1.png',
                    './assets/image/M1/panoramaSectionB2.png',
                    './assets/image/M1/panoramaSectionB3.png'
                ],
                buttons: [
                    { target: 'A', text: 'AREA A', css: { left: '9%', top: '40%' } },
                    { target: 'C', text: 'AREA C', css: { left: '75%', top: '40%' } },
                    { target: 'E', text: 'TURUN KE LT.2 (AREA E)', css: { left: '32.5%', top: '80%' } }
                ],
                toilet: {
                    id: 'toiletB',
                    text: 'SEMBUNYI (TOILET)',
                    css: { left: '20%', top: '70%' } // Sesuaikan posisi
                },
                playerData: { floor: 3, cam: 'B', mapCss: { top: '20%', left: '22%' } }
            },
            'C': {
                images: [
                    './assets/image/M1/panoramaSectionC1.png',
                    './assets/image/M1/panoramaSectionC2.png',
                    './assets/image/M1/panoramaSectionC3.png'
                ],
                buttons: [
                    { target: 'A', text: 'AREA A', css: { left: '55.5%', top: '50%' } }, 
                    { target: 'B', text: 'AREA B', css: { left: '8%', top: '50%' } },
                    { target: 'F', text: 'TURUN KE LT.2 (AREA F)', css: { left: '21%', top: '80%' } }
                ],
                playerData: { floor: 3, cam: 'C', mapCss: { top: '25%', left: '77%' } }
            },

            // --- LANTAI 2 ---
            'D': {
                images: [
                    './assets/image/M1/panoramaSectionD1.png',
                    './assets/image/M1/panoramaSectionD2.png',
                    './assets/image/M1/panoramaSectionD3.png'
                ],
                buttons: [
                    { target: 'A', text: 'NAIK KE LT.3 (AREA A)', css: { left: '80%', top: '20%' } },
                    { target: 'E', text: 'AREA E', css: { left: '57%', top: '50%' } },
                    { target: 'F', text: 'AREA F', css: { left: '68%', top: '50%' } },
                    { target: 'G', text: 'TURUN KE LT.1 (AREA G)', css: { left: '80%', top: '78%' } }
                ],
                toilet: {
                    id: 'toiletE',
                    text: 'SEMBUNYI (TOILET)',
                    css: { left: '20%', top: '70%' } // Sesuaikan posisi
                },
                panels: [
                    {
                        id: 'panelD',
                        text: 'PANEL D',
                        css: { left: '18%', top: '25%' }, 
                        imgClosed: './assets/image/M1/panel/ClosedElectricalPanelSectionD.png',
                        imgOpened: './assets/image/M1/panel/OpenedElectricalPanelSectionD.png'
                    }
                ],
                playerData: { floor: 2, cam: 'D', mapCss: { top: '75%', left: '22%' } }
            },
            'E': {
                images: [
                    './assets/image/M1/panoramaSectionE1.png',
                    './assets/image/M1/panoramaSectionE2.png',
                    './assets/image/M1/panoramaSectionE3.png'
                ],
                buttons: [
                    { target: 'B', text: 'NAIK KE LT.3 (AREA B)', css: { left: '35%', top: '20%' } },
                    { target: 'D', text: 'AREA D', css: { left: '8%', top: '38%' } },
                    { target: 'F', text: 'AREA F', css: { left: '80%', top: '35%' } },
                    { target: 'H', text: 'TURUN KE LT.1 (AREA H)', css: { left: '35%', top: '79%' } }
                ],
                playerData: { floor: 2, cam: 'E', mapCss: { top: '20%', left: '22%' } }
            },
            'F': {
                images: [
                    './assets/image/M1/panoramaSectionF1.png',
                    './assets/image/M1/panoramaSectionF2.png',
                    './assets/image/M1/panoramaSectionF3.png'
                ],
                buttons: [
                    { target: 'E', text: 'AREA E', css: { left: '58%', top: '50%' } },
                    { target: 'C', text: 'NAIK KE LT.3 (AREA C)', css: { left: '60%', top: '20%' } },
                    { target: 'I', text: 'TURUN KE LT.3 (AREA I)', css: { left: '60%', top: '70%' } },
                    { target: 'D', text: 'AREA D', css: { left: '88%', top: '50%' } }
                ],
                playerData: { floor: 2, cam: 'F', mapCss: { top: '25%', left: '77%' } }
            },

            // --- LANTAI 1 ---
            'G': {
                images: [
                    './assets/image/M1/panoramaSectionG1.png',
                    './assets/image/M1/panoramaSectionG2.png',
                    './assets/image/M1/panoramaSectionG3.png'
                ],
                buttons: [
                    { target: 'D', text: 'NAIK KE LT.2 (AREA D)', css: { left: '55%', top: '20%' } },
                    { target: 'H', text: 'AREA H', css: { left: '15%', top: '50%' } },
                    { target: 'J', text: 'AREA H', css: { left: '35%', top: '50%' } },
                ],
                playerData: { floor: 1, cam: 'G', mapCss: { top: '70%', left: '25%' } }
            },
            'H': {
                images: [
                    './assets/image/M1/panoramaSectionH1.png',
                    './assets/image/M1/panoramaSectionH2.png',
                    './assets/image/M1/panoramaSectionH3.png'
                ],
                buttons: [
                    { target: 'E', text: 'NAIK KE LT.2 (AREA E)', css: { left: '77%', top: '20%' } },
                    { target: 'G', text: 'AREA G', css: { left: '67.3%', top: '50%' } },
                    { target: 'I', text: 'AREA I', css: { left: '45%', top: '50%' } },
                ],
                  panels: [
                    {
                        id: 'panelH',
                        text: 'PANEL H',
                        css: { left: '88%', top: '45%' }, // Posisi di Panorama (Sesuaikan nanti)
                        imgClosed: './assets/image/M1/panel/ClosedElectricalPanelSectionH.png',
                        imgOpened: './assets/image/M1/panel/OpenedElectricalPanelSectionH.png'
                    }
                ],
                playerData: { floor: 1, cam: 'H', mapCss: { top: '50%', left: '82%' } }
            },
            'I': {
                images: [
                    './assets/image/M1/panoramaSectionI1.png',
                    './assets/image/M1/panoramaSectionI2.png',
                    './assets/image/M1/panoramaSectionI3.png'
                ],
                buttons: [
                    { target: 'F', text: 'NAIK KE LT.2 (AREA F)', css: { left: '65%', top: '12%' } },
                    { target: 'H', text: 'AREA H', css: { left: '65%', top: '50%' } },
                    { target: 'J', text: 'AREA J', css: { left: '45%', top: '50%' } },
                ],
                  panels: [
                    {
                        id: 'panelI',
                        text: 'PANEL I',
                        css: { left: '65%', top: '25%' }, 
                        imgClosed: './assets/image/M1/panel/ClosedElectricalPanelSectionD.png',
                        imgOpened: './assets/image/M1/panel/OpenedElectricalPanelSectionD.png'
                    }
                ],
                playerData: { floor: 1, cam: 'I', mapCss: { top: '15%', left: '75%' } }
            },
            'J': {
                images: [
                    './assets/image/M1/panoramaSectionJ1.png',
                    './assets/image/M1/panoramaSectionJ2.png',
                    './assets/image/M1/panoramaSectionJ3.png'
                ],
                buttons: [
                    { target: 'I', text: 'AREA I', css: { left: '60%', top: '50%' } },
                    { target: 'G', text: 'AREA G', css: { left: '40%', top: '50%' } },
                ],
                playerData: { floor: 1, cam: 'J', mapCss: { top: '70%', left: '70%' } }
            }
        };

        // --- VISUAL CONFIGURATION RUSTWALKER (CCTV) ---
        /* Format Config:
           img: Path gambar
           css: 
             top/left: Posisi di layar (0% - 100%)
             scale: Ukuran (1 = normal, 0.5 = setengah, 2 = besar)
             brightness: Kecerahan (agar menyatu dengan room yang gelap/terang)
        */
        const rustwalkerVisualConfig = {
            'A': { img: './assets/image/M1/entity/entityOnCCTVRustwalker.png', css: { top: '50%', left: '60%', scale: 0.6, brightness: 1 } },
            'B': { img: './assets/image/M1/entity/entityOnCCTVRustwalker.png', css: { top: '45%', left: '45%', scale: 1.2, brightness: 1 } },
            'C': { img: './assets/image/M1/entity/entityOnCCTVRustwalker.png', css: { top: '46%', left: '50%', scale: 1.5, brightness: 1 } },
            
            'D': { img: './assets/image/M1/entity/entityOnCCTVRustwalker.png', css: { top: '40%', left: '75%', scale: 1, brightness: 1 } },
            'E': { img: './assets/image/M1/entity/entityOnCCTVRustwalker.png', css: { top: '43%', left: '50%', scale: 1.2, brightness: 1 } },
            'F': { img: './assets/image/M1/entity/entityOnCCTVRustwalker.png', css: { top: '45%', left: '50%', scale: 1.5, brightness: 0.5 } },
            
            'G': { img: './assets/image/M1/entity/entityOnCCTVRustwalker.png', css: { top: '50%', left: '55%', scale: 1.1, brightness: 1 } },
            'H': { img: './assets/image/M1/entity/entityOnCCTVRustwalker.png', css: { top: '49%', left: '50%', scale: 1.2, brightness: 0.2 } },
            'I': { img: './assets/image/M1/entity/entityOnCCTVRustwalker.png', css: { top: '50%', left: '50%', scale: 1.3, brightness: 1 } },
            
            // Jaga-jaga jika ada lokasi J
            'J': { img: './assets/image/M1/entity/entityOnCCTVRustwalker.png', css: { top: '50%', left: '50%', scale: 0, brightness: 1 } }
        };

        // --- NOTIFICATION --- code: NTX NOX
        let notification = document.getElementById('notification');
        let notificationData = [
            {
                message: "Carilah panel listrik di titik-titik tertentu dan aktivasikan",
                timeAppear: 0.5,
                timeDisappear: 12
            },
            {
                message: "Cobalah untuk mengaktifkan semua panel listrik tersebut",
                timeAppear: 14,
                timeDisappear: 20
            },
            {
                message: "Berhati-hati lah, karna kamu tidak sendirian disini",
                timeAppear: 22,
                timeDisappear: 26
            },
            {
                message: "kamu di beri waktu hingga jam 00.00 sebelum waktu habis",
                timeAppear: 28,
                timeDisappear: 34
            },
            {
                message: "terdapat monitor yang dapat kamu gunakan untuk melihat kondisi sekitar",
                timeAppear: 36,
                timeDisappear: 46
            },
            {
                message: "Semoga beruntung",
                timeAppear: 48,
                timeDisappear: 59
            },
        ]
        function gameNotification(index){
            setTimeout(() => {
                notification.innerHTML = `${notificationData[index].message}`
                notification.classList.replace("note-inactive","note-active")
            }, notificationData[index].timeAppear*1000);
            setTimeout(() => {
                notification.classList.replace("note-active","note-inactive")
            }, notificationData[index].timeDisappear*1000);
        }

        // --- TIME SYSTEM CONFIG ---
        let gameHour = 18;      // Mulai jam 18:00 (Default)
        let gameMinute = 0;
        let realSecondsPerGameMinute = 4; // 1 menit game = 6 detik asli (Time Speed) code: tmx
        let clockInterval; 

        // --- GAME STATE ---
        let isMonitorUp = false; 
        let isScreenOn = false;  
        let isMoving = false; 
        let currentPan = 50;
        let panSpeed = 1.0;
        let moveDirection = 0;
        
        let currentLocation = 'A'; 
        let currentCamera = 'A';  
        let currentViewFloor = 3; 

        // Variable Player (Dinamis)
        let playerData = locationData['A'].playerData;

        // -> ENTITY 01: "RUSTWALKER" code: enx1
        // --- ENTITY CONFIG (Rustwalker) ---
        const RUSTWALKER_MIN_SPAWN_GAME_MINS = 8; // 18:08
        const RUSTWALKER_MAX_SPAWN_GAME_MINS = 20; // 18:20
        const RUSTWALKER_MIN_MOVE_INTERVAL_SEC = 5; //5
        const RUSTWALKER_MAX_MOVE_INTERVAL_SEC = 27; //27

        let rustwalkerData = {
            name: 'Rustwalker',
            location: 'I', // Start/Spawn location
            floor: 1, 
            isSpawned: false,
        };

        let rustwalkerSpawnMinute = 0; // The calculated random minute (20-30)
        let rustwalkerMoveTimer = null; 

        // Definisi Koneksi dan Probabilitas JALUR ENTITAS
        const entityMovementMap = {
            // Target: Tipe Gerakan (near, far, veryFar, floor)
            'A': { B: 'near', C: 'veryFar', D: 'floor' },
            'B': { A: 'near', C: 'far', E: 'floor' },
            'C': { B: 'far', A: 'veryFar', F: 'floor' },

            'D': { E: 'near', F: 'veryFar', A: 'floor', G: 'floor' },
            'E': { D: 'near', F: 'far', B: 'floor', H: 'floor' },
            'F': { E: 'far', D: 'veryFar', C: 'floor', I: 'floor' },

            'G': { H: 'near', J: 'far', D: 'floor' },
            'H': { G: 'near', I: 'far', E: 'floor' },
            'I': { H: 'far', J: 'near', F: 'floor' },
            'J': { I: 'near', G: 'far' },
        };
        
        const movementProbabilities = {
            near: 34,
            far: 31,
            veryFar: 5,
            floor: 30
        };
        
        const movementTypes = ['near', 'far', 'veryFar', 'floor'];


        // --- ENTITY MOVEMENT LOGIC ---
        function getNextRustwalkerTarget(currentLocation) {
            const possibleMoves = entityMovementMap[currentLocation];
            if (!possibleMoves) return currentLocation;

            // 1. Kumpulkan semua target yang tersedia
            const availableTypes = [...new Set(Object.values(possibleMoves))];
            
            // 2. Lakukan Roll untuk menentukan TIPE pergerakan
            let roll = Math.random() * 100;
            let cumulativeProb = 0;

            for (const type of movementTypes) {
                cumulativeProb += movementProbabilities[type];

                if (roll < cumulativeProb) {
                    // TIPE pergerakan terpilih.
                    
                    // Filter target yang cocok dengan tipe ini
                    const targetsOfType = [];
                    for (const target in possibleMoves) {
                        if (possibleMoves[target] === type) {
                            targetsOfType.push(target);
                        }
                    }

                    // Jika target untuk tipe ini ada
                    if (targetsOfType.length > 0) {
                        let chosenTarget;
                        
                        // Khusus Lantai 2 (D, E, F): Split 30% Floor jadi 15% Naik, 15% Turun
                        if (type === 'floor' && ['D', 'E', 'F'].includes(currentLocation)) {
                            const upTargets = targetsOfType.filter(t => ['A', 'B', 'C'].includes(t));
                            const downTargets = targetsOfType.filter(t => ['G', 'H', 'I'].includes(t));

                            // Roll 50:50 untuk naik atau turun, dari pool 30% Floor
                            if (upTargets.length > 0 && downTargets.length > 0) {
                                if (Math.random() < 0.5) {
                                    chosenTarget = upTargets[Math.floor(Math.random() * upTargets.length)];
                                } else {
                                    chosenTarget = downTargets[Math.floor(Math.random() * downTargets.length)];
                                }
                            } else {
                                // Jika hanya bisa ke satu arah (Naik/Turun), pilih target itu saja
                                chosenTarget = targetsOfType[Math.floor(Math.random() * targetsOfType.length)];
                            }
                        } else {
                            // Kasus umum: Pilih target acak dari tipe yang terpilih
                            chosenTarget = targetsOfType[Math.floor(Math.random() * targetsOfType.length)];
                        }
                        
                        return chosenTarget;
                    }
                    
                    return currentLocation; 
                }
            }
            // Fallback: tetap di lokasi saat ini
            return currentLocation;
        }

        // --- VISUAL UPDATE LOGIC ---
        const cctvRustwalkerEntityImg = document.getElementById('cctvEntityRustwalkerDisplay');

        function updateCctvEntityVisuals() {
            // PRIORITY: Devourer Phase 2 = All Cameras Error
    if (devourerData.active && devourerData.phase === 2) {
        cctvScreen.src = "./assets/image/M1/cctv/cameraError.png";
        // Sembunyikan semua entity cctv lain
        cctvRustwalkerEntityImg.style.display = 'none';
        jesterWrapper.style.display = 'none';
        return; // Stop di sini
    }
            updateJesterVisuals();
            // 1. Cek apakah Entity sudah Spawn
            if (!rustwalkerData.isSpawned) {
                cctvRustwalkerEntityImg.style.display = 'none';
                return;
            }

            // 2. Cek apakah Kamera yang kita lihat == Lokasi Entity
            if (currentCamera === rustwalkerData.location) {
                const visualData = rustwalkerVisualConfig[currentCamera];
                
                if (visualData) {
                    // Update Source Gambar
                    cctvRustwalkerEntityImg.src = visualData.img;
                    
                    // Update CSS Positioning
                    // Kita gunakan Translate -50% -50% agar titik koordinatnya di tengah gambar
                    cctvRustwalkerEntityImg.style.top = visualData.css.top;
                    cctvRustwalkerEntityImg.style.left = visualData.css.left;
                    cctvRustwalkerEntityImg.style.transform = `translate(-50%, -50%) scale(${visualData.css.scale})`;
                    cctvRustwalkerEntityImg.style.filter = `brightness(${visualData.css.brightness})`;
                    
                    // Tampilkan
                    cctvRustwalkerEntityImg.style.display = 'block';
                }
            } else {
                // Jika Entity tidak di kamera ini, sembunyikan
                cctvRustwalkerEntityImg.style.display = 'none';
            }
        }

        // -> ENTITY 02: "THE RUIN"  code: enx2
        // --- THE RUIN CONFIGURATION ---
        const THERUIN_MIN_SPAWN_GAME_MINS = 33; // 18:33
        const THERUIN_MAX_SPAWN_GAME_MINS = 58; // 18:58
        
        // Timer Kematian (Toleransi)
        const THERUIN_DEATH_TIMER_SEC = 7;  // 7
        
        // Interval Muncul Kembali (Real Time: 2 - 7 Menit)
        const THERUIN_RECURRENCE_MIN_SEC = 150; // 2.5 menit
        const THERUIN_RECURRENCE_MAX_SEC = 420; // 7 menit

        let theRuinData = {
            isActive: false,
            hasSpawnedOnce: false,
            deathTimer: null,
            nextSpawnRealTime: null // Timestamp untuk spawn berikutnya
        };

        const ruinEntityDiv = document.getElementById('theRuinEntity');
        const ruinBodyImg = document.getElementById('ruinBody');
        const ruinHeadImg = document.getElementById('ruinHead');

        // VISUAL CONFIG: Posisi Ruin di setiap Panorama (A-J)
        // Default: Top 50%, Left 50%, Scale 1
        const ruinLocationConfig = {
            'A': { top: '50%', left: '65%', scale: 0.5, brightness: 1 },
            'B': { top: '47%', left: '64%', scale: 1, brightness: 1 },
            'C': { top: '45%', left: '43%', scale: 1, brightness: 1 },
            'D': { top: '44%', left: '57%', scale: 1.1, brightness: 1 },
            'E': { top: '46%', left: '32%', scale: 0.7, brightness: 1 },
            'F': { top: '48%', left: '85%', scale: 1, brightness: 1 },
            'G': { top: '43%', left: '27%', scale: 0.7, brightness: 1 },
            'H': { top: '45%', left: '67%', scale: 0.7, brightness: 0.2 },
            'I': { top: '50%', left: '50%', scale: 1, brightness: 1 },
            'J': { top: '50%', left: '50%', scale: 1, brightness: 1 }
        };

        // --- THE RUIN LOGIC ---

        function spawnTheRuin() {
                if (theRuinData.isActive) return;
                
                // Cek apakah config lokasi ada
                const config = ruinLocationConfig[currentLocation];
                if (!config) return;

                console.log(`[THE RUIN] MUNCUL DI ${currentLocation}! PINDAH LANTAI SEKARANG!`);

                theRuinData.isActive = true;
                theRuinData.hasSpawnedOnce = true;

                // 1. Tampilkan Visual
                ruinEntityDiv.style.display = 'block';
                ruinEntityDiv.style.top = config.top;
                ruinEntityDiv.style.left = config.left;
                ruinEntityDiv.style.transform = `translate(-50%, -50%) scale(${config.scale})`;
                ruinEntityDiv.style.filter = `brightness(${config.brightness})`;

                // 2. Efek Audio & Viewport
                theRuinSfx.currentTime = 0;
                theRuinSfx.play();
                viewport.classList.add('ruin-active-effect'); // Tambah animasi flickering

                // 3. Mulai Timer Kematian (5 Detik)
                theRuinData.deathTimer = setTimeout(() => {
                    triggerRuinJumpscare("Waktu Habis");
                }, THERUIN_DEATH_TIMER_SEC * 1000);
        }

        function resetTheRuin(success = false) {
            if (!theRuinData.isActive) return;

            console.log("[THE RUIN] Menghilang...");
            
            // Reset State
            theRuinData.isActive = false;
            clearTimeout(theRuinData.deathTimer);

            // Hilangkan Visual & Efek
            setTimeout(() => {
                theRuinSfx.volume *= 0.1
                ruinEntityDiv.style.display = 'none';
                viewport.classList.remove('ruin-active-effect');
            }, 1000);
            setTimeout(() => {
                theRuinSfx.volume *= 10
            }, 7000);

            if (success) {
                // Jika selamat, atur jadwal muncul berikutnya (2-7 menit lagi)
                const nextIntervalSec = Math.floor(Math.random() * (THERUIN_RECURRENCE_MAX_SEC - THERUIN_RECURRENCE_MIN_SEC + 1)) + THERUIN_RECURRENCE_MIN_SEC;
                
                // Set waktu target (Waktu sekarang + interval)
                theRuinData.nextSpawnRealTime = Date.now() + (nextIntervalSec * 1000);
                
                console.log(`[THE RUIN] Akan kembali dalam ${nextIntervalSec} detik.`);
            }
        }

        function triggerRuinJumpscare(reason) {
            console.log(`[GAME OVER] The Ruin kills you. Reason: ${reason}`);
            
            clearTimeout(theRuinData.deathTimer);
            resetTheRuin(false);  
            
            triggerJumpscare('TheRuin'); 
        }

        // -> ENTITY 03: "THE JESTER" code: enx3
        
        // --- JESTER CONFIG ---
        const JESTER_MIN_SPAWN_GAME_MINS = 70; // 19:10 (1 Jam = 60 menit + 10)
        const JESTER_MAX_SPAWN_GAME_MINS = 90; // 19:30 (1 Jam = 60 menit + 30)
        
        const JESTER_RESPAWN_MIN_SEC = 300; // 5 Menit
        const JESTER_RESPAWN_MAX_SEC = 540; // 9 Menit

        let jesterData = {
            state: 0, // 0: Inactive, 1: Passive, 2: Active (Hunt), 3: Aggressive
            location: null,
            spawnTimeGameMinute: 0,
            nextSpawnRealTime: 0,
            catchCount: 0,     // Berapa kali player berhasil menemukannya
            targetCatchCount: 0, // Target (3-5 kali)
            stareTimer: 0,     // Timer saat player menatap CCTV
            isActive: false    // Flag global
        };

        const jesterWrapper = document.getElementById('cctvJesterWrapper');

        // VISUAL CONFIG JESTER (Sesuaikan path gambar)
const jesterVisualConfig = {
    'A': { css: { top: '50%', left: '50%', scale: 1, brightness: 1 } },
    'B': { css: { top: '50%', left: '50%', scale: 1, brightness: 1 } },
    'C': { css: { top: '50%', left: '50%', scale: 1, brightness: 1 } },
    'D': { css: { top: '50%', left: '50%', scale: 1, brightness: 1 } },
    'E': { css: { top: '50%', left: '50%', scale: 1, brightness: 1 } },
    'F': { css: { top: '50%', left: '50%', scale: 1, brightness: 1 } },
    'G': { css: { top: '50%', left: '50%', scale: 1, brightness: 1 } },
    'H': { css: { top: '50%', left: '50%', scale: 1, brightness: 1 } },
    'I': { css: { top: '50%', left: '50%', scale: 1, brightness: 1 } },
    'J': { css: { top: '50%', left: '50%', scale: 1, brightness: 1 } }
};

        // --- PHASE CONTROL ---

        function calculateJesterFirstSpawn() {
            // Hitung menit total dari jam 18:00. 19:10 = 70 menit setelah start
            jesterData.spawnTimeGameMinute = Math.floor(Math.random() * (JESTER_MAX_SPAWN_GAME_MINS - JESTER_MIN_SPAWN_GAME_MINS + 1)) + JESTER_MIN_SPAWN_GAME_MINS;
            console.log(`[JESTER] Jadwal Fase 1 (Pasif) pada menit ke-${jesterData.spawnTimeGameMinute} in-game`);
        }

        function checkJesterSpawnStatus() {
            // Logic Spawn Fase 1
            if (jesterData.state === 0) {
                // Konversi Jam Game ke Total Menit (Start 18:00)
                let currentTotalMinutes = ((gameHour - 18) * 60) + gameMinute;
                
                // Cek Spawn Pertama
                if (!jesterData.isActive && currentTotalMinutes >= jesterData.spawnTimeGameMinute && jesterData.nextSpawnRealTime === 0) {
                    startJesterPhase1();
                }
                // Cek Respawn (Real Time)
                else if (!jesterData.isActive && jesterData.nextSpawnRealTime > 0 && Date.now() >= jesterData.nextSpawnRealTime) {
                    startJesterPhase1();
                }
            }
        }

        // --- PHASE 1: PASSIVE (Music Box) ---
        function startJesterPhase1() {
            console.log("[JESTER] PHASE 1: PASSIVE STARTED");
            jesterData.state = 1;
            jesterData.isActive = true;
            
            // PAUSE THE RUIN SPAWN
            // (Kita asumsikan variable global theRuinData bisa diakses)
            // Logic pause ruin ada di checkTheRuinStatus, kita tambahkan kondisi pengecekan isActive Jester nanti

            thejesterMusicBoxSfx.currentTime = 0;
            thejesterMusicBoxSfx.play();

            thejesterMusicBoxSfx.onended = () => {
                startJesterPhase2();
            };
        }

        // --- PHASE 2: ACTIVE (The Hunt) ---
        let jesterPhase2CheckInterval;

        function startJesterPhase2() {
            console.log("[JESTER] PHASE 2: HUNT STARTED");
            jesterData.state = 2;
            jesterData.catchCount = 0;
            jesterData.targetCatchCount = Math.round(Math.random() * 1 + 2); // 2 - 3 kali
            console.log(`[JESTER] Player harus menemukan Jester ${jesterData.targetCatchCount} kali.`);

            // Audio Hunt
            thejesterHuntSfx.currentTime = 0;
            thejesterHuntSfx.play();

        
            // Spawn Visual Pertama
            relocateJester();
            // Kita cek setiap 100ms apakah player melihat Jester
            if (jesterPhase2CheckInterval) clearInterval(jesterPhase2CheckInterval);
            jesterPhase2CheckInterval = setInterval(jesterPhase2Logic, 100);

            // Jika Audio Habis & Player belum menang -> FASE 3
            thejesterHuntSfx.onended = () => {
                if (jesterData.state === 2) {
                    clearInterval(jesterPhase2CheckInterval);
                    startJesterPhase3(); // Player Gagal
                }
            };
        }

function relocateJester() {
            // Pilih lokasi random KECUALI lokasi player saat ini DAN KECUALI TITIK J
            const allLocs = Object.keys(locationData);
            
            // Filter: Bukan lokasi player saat ini && Bukan lokasi 'J'
            const validLocs = allLocs.filter(loc => loc !== currentLocation && loc !== 'J');
            
            // Safety check jika array kosong
            if (validLocs.length === 0) return;

            jesterData.location = validLocs[Math.floor(Math.random() * validLocs.length)];
            console.log(`[JESTER] Bersembunyi di ${jesterData.location}`);

            updateCctvEntityVisuals(); // Refresh tampilan CCTV
        }

        function jesterPhase2Logic() {
            if (jesterData.state !== 2) return;

            // Logic Menatap (Stare)
            // Syarat: Monitor Nyala + Camera Benar + Jester ada di sana
            if (isScreenOn && isMonitorUp && currentCamera === jesterData.location) {
                jesterData.stareTimer += 0.1; // Tambah 100ms
                
                // Debug log (optional)
                // console.log("Staring at Jester...", jesterData.stareTimer);

                if (jesterData.stareTimer >= 2.0  ) { // 2 Detik
                    handleJesterCaught();
                }
            } else {
                jesterData.stareTimer = 0; // Reset jika memalingkan pandangan/ganti kamera
            }
        }

        function handleJesterCaught() {
            jesterData.stareTimer = 0; // Reset timer
            jesterData.catchCount++;
            console.log(`[JESTER] Ditemukan! (${jesterData.catchCount}/${jesterData.targetCatchCount})`);

            // Play Scream
            thejesterScream.currentTime = 0;
            thejesterScream.play();

            // Visual Static Error (Transisi)
            const prevLoc = jesterData.location;
            
            // Efek Error CCTV (copy logic dr Rustwalker)
            cctvScreen.src = "./assets/image/M1/cctv/cameraError.png";
            cctvRustwalkerEntityImg.style.display = 'none'; // Sembunyikan entitas lain
            jesterWrapper.style.display = 'none'; // Sembunyikan Jester
            cctvErrorSfx.currentTime = 0; cctvErrorSfx.play();

            // Cek Menang?
            if (jesterData.catchCount >= jesterData.targetCatchCount) {
                // MENANG LAWAN JESTER
                setTimeout(() => {
                    endJesterEncounter(true);
                }, 500);
            } else {
                // BELUM MENANG, PINDAH TEMPAT
                setTimeout(() => {
                    cctvErrorSfx.pause();
                    relocateJester(); // Pindah lokasi baru
                    
                    // Kembalikan view CCTV (Logic updateCctvVisuals dipanggil di dlm relocateJester lwt switchCamera simulasi atau manual)
                    // Karena kita tidak ganti kamera, kita manual update src
                    cctvScreen.src = cameraData[currentCamera];
                    updateCctvEntityVisuals(); 
                    
                }, 500);
            }
        }

        function endJesterEncounter(success) {
            console.log(`[JESTER] Encounter End. Success: ${success}`);
            jesterData.state = 0;
            jesterData.isActive = false;
            clearInterval(jesterPhase2CheckInterval);

            // Reset Audio & Visual
            thejesterHuntSfx.pause();
            jesterWrapper.style.display = 'none';

            // Jadwalkan Respawn (5-9 Menit)
            const nextRespawnSec = Math.floor(Math.random() * (JESTER_RESPAWN_MAX_SEC - JESTER_RESPAWN_MIN_SEC + 1)) + JESTER_RESPAWN_MIN_SEC;
            jesterData.nextSpawnRealTime = Date.now() + (nextRespawnSec * 1000);
            console.log(`[JESTER] Will return in ${nextRespawnSec}s`);
        }

        // --- PHASE 3: AGGRESSIVE (Inevitable Death) ---
        function startJesterPhase3() {
            console.log("[JESTER] PHASE 3: AGGRESSIVE STARTED");
            jesterData.state = 3;
            
            // Hilang dari CCTV
            jesterWrapper.style.display = 'none';
            
            // Audio 1: Pursuing (Sekali)
            thejesterPursuing.currentTime = 0;
            thejesterPursuing.play();

            thejesterPursuing.onended = () => {
                startJesterRunSequence();
            };
        }

        function startJesterRunSequence() {
            console.log("[JESTER] RUNNING...");
            
            // Audio 2: RUN (Looping makin cepat)
            // Kita pakai rekursif setTimeout untuk mengatur kecepatan playback
            
            let runDuration = 10000; // 10 detik total lari
            let startTime = Date.now();
            let currentDelay = 1000; // Mulai 1 detik
            let currentVolume = 0.1;

            function playRunSound() {
                if (Date.now() - startTime > runDuration) {
                    // PERBAIKAN: Panggil fungsi universal langsung
                    triggerJumpscare('TheJester');
                    return;
                }

                thejesterRUN.currentTime = 0;
                thejesterRUN.volume = Math.min(currentVolume, 1.0);
                thejesterRUN.play();

                // Build Up Volume
                currentVolume += 0.1;

                // Percepat Tempo (Kurangi Delay)
                // Kurangi 15% setiap loop, min 100ms
                currentDelay = Math.max(100, currentDelay * 0.85); 

                setTimeout(playRunSound, currentDelay);
            }

            playRunSound(); // Start Loop
        }

        // --- JESTER VISUAL UPDATE (CCTV) ---
        // Panggil fungsi ini di dalam updateCctvEntityVisuals() utama
        function updateJesterVisuals() {
            // Jika Jester tidak aktif di fase 2, sembunyikan
            if (jesterData.state !== 2) {
                jesterWrapper.style.display = 'none';
                return;
            }

            // Jika kamera sesuai lokasi Jester
            if (currentCamera === jesterData.location) {
                const config = jesterVisualConfig[currentCamera];
                if (config) {
                    // PERBAIKAN: JANGAN UBAH TOP/LEFT!
                    // Biarkan CSS #cctvJesterWrapper (top: 15%, left: 16.6%) yang mengatur posisinya agar pas di layar.
                    
                    // Kita hanya atur Scale dan Brightness
                    jesterWrapper.style.transform = `scale(${config.css.scale})`; 
                    jesterWrapper.style.filter = `brightness(${config.css.brightness})`;

                    jesterWrapper.style.display = 'block';
                }
            } else {
                jesterWrapper.style.display = 'none';
            }
        }

        // -> ENTITY 04: "ROTTENNECK" code: enx4
        
        const ROTTENNECK_MIN_SPAWN_GAME_MINS = 110; // 19:50
        const ROTTENNECK_MAX_SPAWN_GAME_MINS = 130; // 20:15
        // const ROTTENNECK_MIN_SPAWN_GAME_MINS = 1; 
        // const ROTTENNECK_MAX_SPAWN_GAME_MINS = 2; 
        
        const ROTTENNECK_RESPAWN_MIN_SEC = 30; // 30 Detik
        const ROTTENNECK_RESPAWN_MAX_SEC = 300; // 5 Menit
        
        // Config Posisi (Left1 = Sisi Kiri Panorama, Left2 = Sisi Kanan Panorama)
        // Top 30% agar terlihat menggantung dari langit-langit
        const rottenneckLocationConfig = {
            'A': { top: '-7%', left1: '14%', left2: '75%', scale: 1.2 },
            'B': { top: '-7%', left1: '14%', left2: '75%', scale: 1.2 },
            'C': { top: '-7%', left1: '14%', left2: '75%', scale: 1.2 },
            'D': { top: '-7%', left1: '14%', left2: '75%', scale: 1.2 },
            'E': { top: '-7%', left1: '14%', left2: '75%', scale: 1.2 },
            'F': { top: '-7%', left1: '14%', left2: '75%', scale: 1.2 },
            'G': { top: '-7%', left1: '14%', left2: '75%', scale: 1.2 },
            'H': { top: '-7%', left1: '14%', left2: '75%', scale: 1.2 },
            'I': { top: '-7%', left1: '14%', left2: '75%', scale: 1.2 },
            'J': { top: '-7%', left1: '14%', left2: '75%', scale: 1.2 }
        };

        let rottenneckData = {
            active: false,
            phase: 0, // 0: Idle, 1: Audio Cue, 2: Visual (Attack)
            spawnTimeGameMinute: 0,
            nextSpawnRealTime: 0,
            currentSide: 0, // 1: Kiri, 2: Kanan
            stareTimer: 0,
            failTimer: null
        };

        const rottenneckEntity = document.getElementById('rottenneckEntity');
        const rottenneckJaw = document.getElementById('rottenneckJaw');
        
        let rottenneckStareInterval = null;

        // --- PHASE 2: VISUAL ATTACK ---
        function startRottenneckPhase2() {
            if(isHiding){
                    console.log("[ROTTENNECK] CAN'T FIND YOU");
                    clearInterval(rottenneckStareInterval);
                    clearTimeout(rottenneckData.failTimer);
                    rottenneckEntity.style.display = 'none';
                    rottenneckJaw.classList.remove('jaw-scream');
                    rottenneckData.active = false;
                    rottenneckData.phase = 0;
                return}
            console.log("[ROTTENNECK] PHASE 2: VISUAL APPEAR");
            rottenneckData.phase = 2;
            rottenneckData.stareTimer = 0;

            // 1. Pilih Sisi (1: Kiri, 2: Kanan)
            const side = Math.random() < 0.5 ? 1 : 2;
            rottenneckData.currentSide = side;
            
            const config = rottenneckLocationConfig[currentLocation];
            const targetLeft = side === 1 ? config.left1 : config.left2;
            
            // 2. Setup Posisi & Animasi Turun
            rottenneckEntity.style.left = targetLeft;
            switch (side) {
                    case 1:
                        rottenneckEntity.style.transform = `scale(${config.scale}) scaleX(1)`;
                    break;
                    default:
                        rottenneckEntity.style.transform = `scale(${config.scale}) scaleX(-1)`;
                    break;
            }
            rottenneckEntity.style.display = 'block';
            
            // Force reflow agar transisi CSS jalan
            void rottenneckEntity.offsetWidth; 
            
            // Slide Turun
            rottenneckEntity.style.top = config.top; 

            // 3. Play SFX lagi (Gemeretak)
            rottenneckSFX.currentTime = 0;
            rottenneckSFX.play();

            // 4. Mulai Timer Kematian (8 Detik)
            rottenneckData.failTimer = setTimeout(() => {
                if (rottenneckData.phase === 2) {
                    // Jumpscare jika gagal menatap
                    triggerJumpscare('Rottenneck'); // Pastikan tambah logic ini di triggerJumpscare
                }
            }, 8000);

            // 5. Mulai Loop Cek Tatapan
            if (rottenneckStareInterval) clearInterval(rottenneckStareInterval);
            rottenneckStareInterval = setInterval(checkRottenneckStare, 100);
        }

        function checkRottenneckStare() {
            if (rottenneckData.phase !== 2) return;
            if (isMonitorUp) return; // Tidak bisa menatap jika buka monitor

            // LOGIKA SUDUT PANDANG (FOV)
            // #main lebar 300%. Viewport lebar 100% (sepertiga dari main).
            // Posisi Viewport (Visible Area) dalam % terhadap #main:
            // Start (Kiri) = (currentPan / 100) * 66.666
            // End (Kanan)  = Start + 33.333
            // Center View  = Start + 16.666
            
            const visibleStart = (currentPan / 100) * 66.666;
            const viewCenter = visibleStart + 16.666;

            // Ambil posisi entitas (misal 12% atau 88%)
            const config = rottenneckLocationConfig[currentLocation];
            const entityPosStr = rottenneckData.currentSide === 1 ? config.left1 : config.left2;
            const entityPos = parseFloat(entityPosStr);

            // Cek Jarak antara Tengah Layar dengan Posisi Entitas
            // Toleransi 5% (cukup ketat, pemain harus benar-benar menoleh)
            if (Math.abs(viewCenter - entityPos) < 12.0) {
                rottenneckData.stareTimer += 0.1; // Tambah 100ms
                // console.log("Staring at Rottenneck...", rottenneckData.stareTimer);
                
                if (rottenneckData.stareTimer >= 2.0) {
                    rottenneckSuccess();
                }
            } else {
                // Reset timer jika memalingkan muka (opsional, atau biarkan akumulatif?)
                // Jika ingin sulit: reset. Jika ingin mudah: jangan reset.
                // rottenneckData.stareTimer = 0; 
            }
        }

        function rottenneckSuccess() {
            console.log("[ROTTENNECK] REPELLED!");
            clearInterval(rottenneckStareInterval);
            clearTimeout(rottenneckData.failTimer);
            rottenneckData.phase = 3; // Retreating

            // 1. Animasi & Audio Teriak
            rottenneckScreamSFX.currentTime = 0;
            rottenneckScreamSFX.play();
            
            // Buka Mulut Lebar
            rottenneckJaw.classList.add('jaw-scream');

            // 2. Slide Naik (Kabur) setelah 1 detik
            setTimeout(() => {
                rottenneckEntity.style.top = '-120%'; // Naik ke atas
                
                // 3. Reset total setelah animasi selesai
                setTimeout(() => {
                    rottenneckEntity.style.display = 'none';
                    rottenneckJaw.classList.remove('jaw-scream');
                    rottenneckData.active = false;
                    rottenneckData.phase = 0;
                    
                    // Jadwalkan Spawn Berikutnya
                    const nextSec = Math.floor(Math.random() * (ROTTENNECK_RESPAWN_MAX_SEC - ROTTENNECK_RESPAWN_MIN_SEC + 1)) + ROTTENNECK_RESPAWN_MIN_SEC;
                    rottenneckData.nextSpawnRealTime = Date.now() + (nextSec * 1000);
                    console.log(`[ROTTENNECK] Gone. Back in ${nextSec}s.`);
                }, 1500);

            }, 1000);
        }

        // -> ENTITY 05: "DEVOURER" code: enx5
        
        const DEVOURER_MIN_SPAWN_GAME_MINS = 150; // 20:30 150
        const DEVOURER_MAX_SPAWN_GAME_MINS = 190; // 21:10 190
        const DEVOURER_MIN_MOVE_INTERVAL_SEC = 600; // 10 menit
        const DEVOURER_MAX_MOVE_INTERVAL_SEC = 720; // 12 menit

        // Config Posisi Devourer di Panorama
        const devourerLocationConfig = {
            'A': { top: '50%', left: '48%', scale: 1, forcedPanoramaView: 48},
            'B': { top: '50%', left: '12.5%', scale: 1, forcedPanoramaView: 0},
            'C': { top: '50%', left: '53%', scale: 1, forcedPanoramaView: 50},
            'D': { top: '50%', left: '48%', scale: 1, forcedPanoramaView: 50},
            'E': { top: '50%', left: '50%', scale: 1, forcedPanoramaView: 50},
            'F': { top: '50%', left: '50%', scale: 1, forcedPanoramaView: 50},
            'G': { top: '50%', left: '50%', scale: 1, forcedPanoramaView: 50},
            'H': { top: '50%', left: '50%', scale: 1, forcedPanoramaView: 50},
            'I': { top: '50%', left: '50%', scale: 1, forcedPanoramaView: 50},
            'J': { top: '50%', left: '50%', scale: 1, forcedPanoramaView: 50}
        };

        let devourerData = {
            active: false,
            phase: 0, // 0: Idle, 1: AudioCue, 2: ErrorCCTV, 3: Attack
            spawnTimeGameMinute: 0,
            nextSpawnRealTime: 0
        };

        const devourerEntity = document.getElementById('devourerEntity');

        function calculateDevourerFirstSpawn() {
            const spawnMin = Math.floor(Math.random() * (DEVOURER_MAX_SPAWN_GAME_MINS - DEVOURER_MIN_SPAWN_GAME_MINS + 1)) + DEVOURER_MIN_SPAWN_GAME_MINS;
            devourerData.spawnTimeGameMinute = spawnMin;
            console.log(`[DEVOURER] Jadwal Fase 1 pada menit ke-${spawnMin} in-game`);
        }

        function checkDevourerSpawnStatus() {
            if (devourerData.active) return;

            let currentTotalMinutes = ((gameHour - 18) * 60) + gameMinute;

            // Spawn Check
            if ((devourerData.nextSpawnRealTime === 0 && currentTotalMinutes >= devourerData.spawnTimeGameMinute) ||
                (devourerData.nextSpawnRealTime > 0 && Date.now() >= devourerData.nextSpawnRealTime)) {
                
                startDevourerPhase1();
            }
        }

        // FASE 1: SUARA (15 Detik)
        function startDevourerPhase1() {
            console.log("[DEVOURER] PHASE 1");
            devourerData.active = true;
            devourerData.phase = 1;
            
            devourerAppearanceSFX.currentTime = 0;
            devourerAppearanceSFX.play();

            setTimeout(startDevourerPhase2, 15000);
        }

        // FASE 2: AMBIENT & CCTV ERROR (15 Detik)
        function startDevourerPhase2() {
            console.log("[DEVOURER] PHASE 2");
            devourerData.phase = 2;

            devourerAppearanceSFX.pause();
            devourerAmbientSFX.currentTime = 0;
            devourerAmbientSFX.play();
            
            // Efek Kedip Ringan
            viewport.classList.add('ruin-active-effect'); // Pakai efek flicker yg ada tp durasi lambat? 
            // Atau manual interval flicker ringan

            // Force Update CCTV Error (Karena fase 2 aktif, fungsi updateCctvEntityVisuals akan handle gambar error)
            updateCctvEntityVisuals(); 

            setTimeout(startDevourerPhase3, 15000);
        }

        // FASE 3: AGGRESSIVE (Jumpscare Check)
        function startDevourerPhase3() {
            console.log("[DEVOURER] PHASE 3: CHECK KILL");
            devourerData.phase = 3;
            
            // Reset Efek Fase 2
            viewport.classList.remove('ruin-active-effect');
            
            // Audio Scream
            devourerScreamSFX.currentTime = 0;
            devourerScreamSFX.play();

            // Efek Kedip Berat (Strobe)
            viewport.style.animation = "strobeFlash 0.1s steps(2, start) infinite";



            // Tunggu sebentar (misal 4 detik) sebelum Kill/Selamat
            setTimeout(() => {
                if (isHiding) {
                    // SELAMAT
                    console.log("[DEVOURER] Player Hiding. Safe.");
                    devourerRetreat();
                } else {
                    // MATI
                    triggerJumpscare('Devourer');
                }
            }, 4000);
        }

        function devourerRetreat() {
            devourerEntity.style.display = 'none';
            viewport.style.animation = "breathingView 4s infinite ease-in-out, animasiLampuRedup 5s infinite alternate"; // Stop strobe
            devourerData.active = false;
            devourerData.phase = 0;
            devourerAmbientSFX.pause()

            // Update CCTV kembali normal
            updateCctvEntityVisuals();

            // Jadwal Next Spawn
            const nextSec = Math.floor(Math.random() * (DEVOURER_MAX_MOVE_INTERVAL_SEC - DEVOURER_MIN_MOVE_INTERVAL_SEC + 1)) + DEVOURER_MIN_MOVE_INTERVAL_SEC;
            devourerData.nextSpawnRealTime = Date.now() + (nextSec * 1000);
            console.log(`[DEVOURER] Retreat. Back in ${nextSec}s`);
        }

        // --- CHECKER (Dipanggil di GameLoop/Timer) ---
        
        let ruinSpawnMinute = 0; // Waktu random pertama kali

        function calculateRuinFirstSpawn() {
            ruinSpawnMinute = Math.floor(Math.random() * (THERUIN_MAX_SPAWN_GAME_MINS - THERUIN_MIN_SPAWN_GAME_MINS + 1)) + THERUIN_MIN_SPAWN_GAME_MINS;
            console.log(`[THE RUIN] Jadwal muncul pertama jam 18:${ruinSpawnMinute}`);
        }

        function checkTheRuinStatus() {
            if (jesterData.isActive) return;

            // 1. Cek Spawn Pertama (Berdasarkan Jam Game)
            if (!theRuinData.hasSpawnedOnce) {
                if (gameHour === 18 && gameMinute >= ruinSpawnMinute) {
                    spawnTheRuin();
                }
            } 
            // 2. Cek Spawn Berikutnya (Berdasarkan Waktu Nyata)
            else if (theRuinData.nextSpawnRealTime && Date.now() >= theRuinData.nextSpawnRealTime) {
                if (!theRuinData.isActive) {
                    spawnTheRuin();
                    theRuinData.nextSpawnRealTime = null; // Reset agar tidak loop
                }
            }
        }

        function calculateRottenneckFirstSpawn() {
            // Random menit antara 19:50 - 20:15
            const spawnMin = Math.floor(Math.random() * (ROTTENNECK_MAX_SPAWN_GAME_MINS - ROTTENNECK_MIN_SPAWN_GAME_MINS + 1)) + ROTTENNECK_MIN_SPAWN_GAME_MINS;
            rottenneckData.spawnTimeGameMinute = spawnMin;
            console.log(`[ROTTENNECK] Jadwal Fase 1 pada menit ke-${spawnMin} in-game`);
        }

        function checkRottenneckSpawnStatus() {
            if (rottenneckData.active) return;

            let currentTotalMinutes = ((gameHour - 18) * 60) + gameMinute;

            // Spawn Pertama
            if (rottenneckData.nextSpawnRealTime === 0 && currentTotalMinutes >= rottenneckData.spawnTimeGameMinute) {
                startRottenneckPhase1();
            }
            // Respawn
            else if (rottenneckData.nextSpawnRealTime > 0 && Date.now() >= rottenneckData.nextSpawnRealTime) {
                startRottenneckPhase1();
            }
        }

        // --- PHASE 1: AUDIO CUE ---
        function startRottenneckPhase1() {
            console.log("[ROTTENNECK] PHASE 1: AUDIO CUE");
            rottenneckData.active = true;
            rottenneckData.phase = 1;

            rottenneckSFX.currentTime = 0;
            rottenneckSFX.play();

            // Setelah audio selesai (atau delay 5 detik), masuk Fase 2
            // Kita pakai timeout 5 detik untuk simulasi durasi audio
            setTimeout(() => {
                startRottenneckPhase2();
            }, 5000); 
        }

 // --- JUMPSCARE LOGIC ---
        const jumpscareLayer = document.getElementById('jumpscareLayer');
        const viewport = document.getElementById('viewport');

        // --- UNIVERSAL JUMPSCARE FUNCTION ---
        function triggerJumpscare(killerName) {
            console.log(`[GAME OVER] Jumpscare triggered by: ${killerName}`);

            // 1. STOP SEMUA SISTEM
            clearInterval(clockInterval);
            clearInterval(jesterPhase2CheckInterval); // Stop Jester Loop
            clearTimeout(rustwalkerMoveTimer);
            clearTimeout(theRuinData.deathTimer);
            clearTimeout(rottenneckData.failTimer); // Stop timer rottenneck
            clearInterval(rottenneckStareInterval);
            
            isMoving = true; 
            navLayer.style.pointerEvents = "none"; 
            cctvBtn.style.pointerEvents = "none"; 

            // 2. MATIKAN UI & AUDIO LINGKUNGAN
            monitorWrapper.style.display = 'none'; 
            cctvBtn.style.display = 'none';
            bgAudio.pause();
            cctvStatic.pause();
            thejesterHuntSfx.pause(); // Stop suara fase 2
            thejesterPursuing.pause();
            thejesterRUN.pause();

            // 3. SETUP GAMBAR & CLASS JUMPSCARE
            const jumpscareImg = document.getElementById('jumpscareImg');
            jumpscareLayer.className = ''; // Reset class list

            if (killerName === 'TheRuin') {
                jumpscareImg.src = "./assets/image/M1/entity/theRuinHead.png"; 
                jumpscareLayer.classList.add('jumpscare-active-TheRuin'); 
            } 
            else if (killerName === 'TheJester') {
                jumpscareImg.src = "./assets/image/M1/entity/theJesterHead.png"; 
                jumpscareLayer.classList.add('jumpscare-active-TheJester'); 
            }else if (killerName === 'Rottenneck' || killerName ==="The Rottenneck") {
                jumpscareImg.src = "./assets/image/M1/entity/rottenneckHEAD.png"; 
                jumpscareLayer.classList.add('jumpscare-active-Rottenneck');
            }
            else { 
                jumpscareImg.src = "./assets/image/M1/entity/RustwalkerStatic.png";
                jumpscareLayer.classList.add('jumpscare-active-Rustwalker');
            }

            
            // Efek Strobe Layar
            if (killerName !== 'Devourer') {
            // 4. EKSEKUSI VISUAL
            jumpscareLayer.style.display = 'block'; 

            viewport.style.animation = "none";
            setTimeout(() => {
                viewport.style.animation = "strobeFlash 0.05s steps(2, start) infinite";
            }, 10);

                // 5. AUDIO JUMPSCARE
            jumpscare1Sfx.currentTime = 0;
            jumpscare1Sfx.volume = 1.0;
            jumpscare1Sfx.play().catch(e => console.log("Audio fail:", e));
    
            // 6. DEATH SCREEN SEQUENCE 
            setTimeout(() => {
                showDeathScreen(killerName);
                
            }, 4000); // Tunggu 4 Detik setelah jumpscare mulai
        } 
        else {
             // Tampilkan Entity di Panorama (Visual Attack)
            const config = devourerLocationConfig[currentLocation];
            // Fallback config
            const safeConfig = config 
            
            devourerEntity.style.display = 'block';
            // devourerEntity.style.top = safeConfig.top;
            devourerEntity.style.left = safeConfig.left;
            currentPan = safeConfig.forcedPanoramaView
            devourerEntity.classList.add("death")

             setTimeout(() => {
                showDeathScreen(killerName);
                
            }, 4000); // Tunggu 4 Detik setelah jumpscare mulai
        }
        }


// Update checkPlayerCollision agar menerima parameter 'killer'
     function checkPlayerCollision(forcedKiller = null) {
            // Jika dipaksa (misal oleh logic The Ruin/Jester fase akhir)
            if (forcedKiller) {
                triggerJumpscare(forcedKiller);
                return;
            }
            // Deteksi Manual (Rustwalker)
            if (rustwalkerData.location === currentLocation && !isHiding) {
                triggerJumpscare('Rustwalker');
            }
        }

        // --- KONSTANTA BARU ---
        const TRANSITION_DURATION_MS = 500; // 0.5 detik untuk efek error

        function moveRustwalker() {
            clearTimeout(rustwalkerMoveTimer); 

            const newLocation = getNextRustwalkerTarget(rustwalkerData.location);
            const oldLocation = rustwalkerData.location;

            if (newLocation && newLocation !== oldLocation) {
                
                // Cek kondisi: Apakah Entity bergerak saat player sedang melihat kamera LAMA?
                const isPlayerWatching = currentCamera === oldLocation && isScreenOn;

                if (isPlayerWatching) {
                    // --- AKTIVASI EFEK ERROR CCTV ---
                    
                    // 1. Ganti tampilan layar dengan gambar error dan mainkan SFX
                    cctvScreen.src = "./assets/image/M1/cctv/cameraError.png";
                    cctvRustwalkerEntityImg.style.display = 'none'; // Sembunyikan entity selama transisi
                    cctvErrorSfx.currentTime = 0; // Mulai dari awal
                    cctvErrorSfx.play();

                    setTimeout(() => {
                        // 2. Setelah 0.5 detik, pindahkan Entity ke lokasi baru secara logis
                        rustwalkerData.location = newLocation;
                        rustwalkerData.floor = locationData[newLocation].playerData.floor;
                        
                        console.log(`[Rustwalker] Pindah dari: ${oldLocation} (Lantai ${locationData[oldLocation].playerData.floor}) ke: ${rustwalkerData.location} (Lantai ${rustwalkerData.floor})`);
                        
                        // 3. Update tampilan layar ke kamera BARU 
                        cctvScreen.src = cameraData[currentCamera]
                        
                        // 4. Update visual entity di kamera baru (penting untuk menghilangkan Entity di kamera lama)
                        updateCctvEntityVisuals(); 

                        // 5. Matikan SFX
                        cctvErrorSfx.pause();

                    }, TRANSITION_DURATION_MS); 
                    
                } else {
                    // --- PERGERAKAN NORMAL (Player tidak melihat) ---
                    rustwalkerData.location = newLocation;
                    rustwalkerData.floor = locationData[newLocation].playerData.floor;
                    
                    console.log(`[Rustwalker] Pindah dari: ${oldLocation} (Lantai ${locationData[oldLocation].playerData.floor}) ke: ${rustwalkerData.location} (Lantai ${rustwalkerData.floor})`);
                    
                    // Update visual entity hanya jika monitor aktif
                    if (isScreenOn) updateCctvEntityVisuals(); 
                }

            } else {
                 console.log(`[Rustwalker] Tidak bergerak, tetap di: ${rustwalkerData.location} (Lantai ${rustwalkerData.floor})`);
                 
                 // Tetap panggil update visuals jika monitor aktif, jaga-jaga jika ada bug render
                 if (isScreenOn) updateCctvEntityVisuals();
            }

            checkPlayerCollision(); 

            // Set waktu interval bergerak berikutnya (10-30 detik nyata)
            const nextIntervalSec = Math.floor(Math.random() * (RUSTWALKER_MAX_MOVE_INTERVAL_SEC - RUSTWALKER_MIN_MOVE_INTERVAL_SEC + 1)) + RUSTWALKER_MIN_MOVE_INTERVAL_SEC;

            // Panggil kembali fungsi moveRustwalker setelah interval
            rustwalkerMoveTimer = setTimeout(moveRustwalker, nextIntervalSec * 1000);
            console.log(`[Rustwalker] Akan bergerak lagi dalam ${nextIntervalSec} detik nyata.`);
        }

        function startRustwalkerMovement() {
            // Panggil fungsi gerakan pertama
            moveRustwalker();
            updateCctvEntityVisuals();
        }

        // --- SPAWN LOGIC ---

        function calculateSpawnTime() {
            // Menghitung menit spawn game (20 - 30)
            const randomMin = Math.floor(Math.random() * (RUSTWALKER_MAX_SPAWN_GAME_MINS - RUSTWALKER_MIN_SPAWN_GAME_MINS + 1)) + RUSTWALKER_MIN_SPAWN_GAME_MINS;
            rustwalkerSpawnMinute = randomMin;
            console.log(`[Rustwalker] Akan muncul pada jam 18:${rustwalkerSpawnMinute.toString().padStart(2, '0')}`);
        }

        function checkSpawnTime() {
            if (rustwalkerData.isSpawned) return;

            // Cek apakah sudah jam 18:XX dan menitnya sudah mencapai batas random
            if (gameHour === 18 && gameMinute >= rustwalkerSpawnMinute) {
                rustwalkerData.isSpawned = true;
                console.log(`[Rustwalker] ENTITAS AKTIF! Muncul di titik awal: ${rustwalkerData.location} (Lantai ${rustwalkerData.floor})`);
                startRustwalkerMovement();
            }
        }

        // --- MOVEMENT LOGIC TERBARU (MULTI TOMBOL) ---

        // Fungsi untuk merender tombol berdasarkan lokasi saat ini
   function renderNavButtons() {
            navLayer.innerHTML = ''; 
            const data = locationData[currentLocation];

            // 1. Render Tombol Navigasi Biasa
            if (data && data.buttons) {
                data.buttons.forEach(btnData => {
                    const btn = document.createElement('div');
                    btn.className = 'nav-btn'; 
                    btn.innerText = btnData.text;
                    btn.style.left = btnData.css.left;
                    btn.style.top = btnData.css.top;
                    
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        if(isMoving || isMonitorUp) return;
                        startMovementSequence(btnData.target);
                    });
                    navLayer.appendChild(btn);
                });
            }

            // 2. Render Tombol Panel Listrik (Baru)
            if (data && data.panels) {
                data.panels.forEach(pnlData => {
                    const btn = document.createElement('div');
                    btn.className = 'nav-btn panel-trigger-btn'; // Tambah class merah
                    btn.innerText = pnlData.text;
                    btn.style.left = pnlData.css.left;
                    btn.style.top = pnlData.css.top;
                    
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if(isMoving || isMonitorUp) return;
                        
                        // Masuk ke Mode Panel
                        enterPanelView(pnlData);
                    });
                    navLayer.appendChild(btn);
                });
            }

            // 3. Render Tombol Toilet (Baru)
            if (data && data.toilet) {
                const toiletData = data.toilet;
                const btn = document.createElement('div');
                btn.className = 'nav-btn toilet-entry-btn'; // Class khusus hijau
                btn.innerText = toiletData.text;
                btn.style.left = toiletData.css.left;
                btn.style.top = toiletData.css.top;
                
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if(isMoving || isMonitorUp) return;
                    
                    // Masuk Toilet
                    enterToilet();
                });
                navLayer.appendChild(btn);
            }
        }

        // --- TOILET / HIDEOUT SYSTEM ---
        const toiletLayer = document.getElementById('toiletLayer');
        const btnExitToilet = document.getElementById('btnExitToilet');
        let isHiding = false;

        function enterToilet() {
            isHiding = true;
            
            // Efek Suara Pintu
            // (Opsional: btnSfx.play() atau sfx pintu toilet)
            btnSfx.currentTime = 0; btnSfx.play();

            transitionOverlay.style.opacity = 1;

            setTimeout(() => {
                toiletLayer.style.display = 'block';
                navLayer.style.display = 'none'; // Sembunyikan navigasi luar
                
                // Pastikan Entity Panorama (Devourer/Rottenneck/Ruin) tidak terlihat dari dalam toilet
                // Tapi logika mereka tetap jalan di background
                
                transitionOverlay.style.opacity = 0;
            }, 1000);
        }

        function exitToilet() {
            // Cek The Ruin sebelum keluar (Jika The Ruin aktif, keluar = mati? 
            // Sesuai prompt: "tidak aman dari the ruin", jadi Ruin bisa bunuh walau di dalam)
            
            isHiding = false;
            btnSfx.currentTime = 0; btnSfx.play();

            transitionOverlay.style.opacity = 1;

            setTimeout(() => {
                toiletLayer.style.display = 'none';
                navLayer.style.display = 'block'; 
                
                transitionOverlay.style.opacity = 0;
            }, 1000);
        }

        btnExitToilet.addEventListener('click', exitToilet);

        // --- ELECTRICAL PANEL LOGIC ---
        const panelViewLayer = document.getElementById('panelViewLayer');
        const panelViewImg = document.getElementById('panelViewImg');
        const panelLeftBtn = document.getElementById('panelLeftBtn');
        const panelCenterBtn = document.getElementById('panelCenterBtn');
        const PanelActivationBtn = document.getElementById('PanelActivationBtn');

        let isFocusingPanel = false;
        let isPanelOpen = false; // State panel saat ini
        let currentPanelData = null;

        function enterPanelView(pnlData) {
            isFocusingPanel = true;
            currentPanelData = pnlData;
            isPanelOpen = false; // Reset state panel selalu tertutup saat datang

            // 1. Transition Fade Out (Layar Hitam)
            transitionOverlay.style.opacity = 1;

            setTimeout(() => {
                // 2. Setup Tampilan Panel
                panelViewLayer.style.display = 'block';
                panelViewImg.src = pnlData.imgClosed; // Gambar Tertutup Awal
                navLayer.style.display = 'none'; // Sembunyikan tombol panorama
                cctvBtn.style.display = "none";
                
                // Setup Tombol
                updatePanelButtonsState();

                // 3. Transition Fade In
                transitionOverlay.style.opacity = 0;
            }, 1000); // 1 Detik Transisi
        }

        function exitPanelView() {
            if (isMinigameOpen) closeMinigame();

            // 1. Transition Fade Out
            transitionOverlay.style.opacity = 1;

            setTimeout(() => {
                // 2. Reset Tampilan ke Panorama
                panelViewLayer.style.display = 'none';
                navLayer.style.display = 'block'; // Munculkan tombol panorama lagi
                cctvBtn.style.display = "block";

                isFocusingPanel = false;
                currentPanelData = null;

                // 3. Transition Fade In
                transitionOverlay.style.opacity = 0;
            }, 1000);
        }

        function togglePanelDoor() {
            if (isMinigameOpen) return;
            if(!currentPanelData) return;

            // Transisi Cepat (0.2s)
            transitionOverlay.style.transition = "opacity 0.2s ease-in-out";
            transitionOverlay.style.opacity = 1;

            setTimeout(() => {
                if (!isPanelOpen) {
                    // AKSI: MEMBUKA
                    isPanelOpen = true;
                    panelViewImg.src = currentPanelData.imgOpened;
                    openElectricalPanel.currentTime = 0;
                    openElectricalPanel.play();
                } else {
                    // AKSI: MENUTUP
                    isPanelOpen = false;
                    panelViewImg.src = currentPanelData.imgClosed;
                    closeElectricalPanel.currentTime = 0;
                    closeElectricalPanel.play();
                }
                
                updatePanelButtonsState();

                // Buka Layar lagi
                transitionOverlay.style.opacity = 0;
                
                // Kembalikan speed transisi ke default (1s) setelah selesai
                setTimeout(() => {
                    transitionOverlay.style.transition = "opacity 1s ease-in-out";
                }, 200);

            }, 200);
        }

       function updatePanelButtonsState() {
            if (!isPanelOpen) {
                // KONDISI TERTUTUP
                panelLeftBtn.innerText = "KEMBALI";
                panelCenterBtn.style.display = "block"; 
                panelCenterBtn.innerText = "BUKA PANEL";
                PanelActivationBtn.style.display = "none";
                
                panelLeftBtn.onclick = exitPanelView;
                panelCenterBtn.onclick = togglePanelDoor;
                
                // Pastikan minigame tertutup jika panel ditutup paksa
                if(isMinigameOpen) closeMinigame();

            } else {
                // KONDISI TERBUKA
                panelLeftBtn.innerText = "TUTUP PANEL";
                panelCenterBtn.style.display = "none"; 
                
                // Cek apakah Quest sudah selesai? Jika belum, tampilkan tombol
                if (!questData[currentLocation] || !questData[currentLocation].isComplete) {
                    PanelActivationBtn.style.display = "block";
                } else {
                    PanelActivationBtn.style.display = "none";
                }

                // Event Listener
                panelLeftBtn.onclick = togglePanelDoor; 
                
                // --- SAMBUNGKAN TOMBOL INI KE LOGIC MINIGAME ---
                PanelActivationBtn.onclick = togglePanelActivation;
            }
        }

        // --- QUEST / PANEL SYSTEM DATA --- code: qdx
        const questData = {
            "A": {
                isUnlocked: true, // Bisa diakses
                progress: 1,      // Level saat ini (1, 2, 3, 4, 5)
                maxProgress: 5,
                type: "memory",
                isComplete: false,
                config: {
                    1: { cols: 3, emojis: ["ðŸŽ","ðŸ‰","ðŸŒ"] },
                    2: { cols: 5, emojis: ["ðŸš—","ðŸšŒ","ðŸš‹","ðŸšš","ðŸš€"] },
                    3: { cols: 7, emojis: ["ðŸŽ¨","ðŸŽ²","ðŸ“–","ðŸ’¡","ðŸ“","âŒ›","ðŸ—¿"] },
                    4: { cols: 9, emojis: ["ðŸš«","ðŸ”‡","ðŸ”•","ðŸš­","ðŸš·",'ðŸš¯',"ðŸš³",'ðŸš±',"ðŸ“µ"] },
                    5: { cols: 11, emojis: ["A","B","C","D","E","F","G","H","I","J","K"] },
                }
            },
           "D": { // TIMING GAME
                isUnlocked: true, 
                progress: 1,
                maxProgress: 10,
                type: "timing",
                isComplete: false,
                // Konfigurasi level Timing Game (kecepatan bar, jumlah & lebar hitzone)
                config: { 
                    1: { speed: 1.0, zones: 1, width: 20.0 },  // Cepat, 1 zona lebar
                    2: { speed: 1.1, zones: 1, width: 18.0 },
                    3: { speed: 1.2, zones: 1, width: 16.0 },
                    4: { speed: 1.3, zones: 1, width: 14.0 },  // 2 zona tipis
                    5: { speed: 1.4, zones: 1, width: 13.0 },
                    6: { speed: 1.5, zones: 1, width: 8.0 },  // 3 zona lebih cepat
                    7: { speed: 1.6, zones: 1, width: 6.0 },
                    8: { speed: 1.7, zones: 1, width: 5.0 }, // 4 zona paling sulit
                    9: { speed: 1.8, zones: 1, width: 4.5 },
                    10: { speed: 2.0, zones: 1, width: 3.0 } // Sangat cepat, 5 zona sangat tipis
                }
            },
            "H": {
                isUnlocked: true, 
                progress: 1,      
                maxProgress: 8,
                type: "memory",
                isComplete: false,
                config: {
                    1: { cols: 3, emojis: ["ðŸŽˆ","ðŸŽ‰","ðŸŽ"] },
                    2: { cols: 5, emojis: ["âš½","âš¾","ðŸ¥Ž","ðŸ€","ðŸ"] },
                    3: { cols: 7, emojis: ["ðŸŒ³","ðŸŒ´","ðŸŒµ","ðŸŒ¾","ðŸŒ¿","ðŸ€","ðŸŒ²"] },
                    4: { cols: 9, emojis: ["ðŸŒ‘","ðŸŒ’","ðŸŒ“","ðŸŒ”","ðŸŒ•",'ðŸŒ–',"ðŸŒ—",'ðŸŒ˜',"ðŸŒ™"] },
                    5: { cols: 11, emojis: ["Z","Y","X","W","V","U","T","S","R","Q","P"] },
                    6: { cols: 11, emojis: ["ðŸ°","ðŸ ","ðŸ¡","â›ª","ðŸ¢","ðŸ£","ðŸ¤","ðŸ¥","ðŸ¦","ðŸ¨","ðŸª"] },
                    7: { cols: 11, emojis: ["ðŸš®","ðŸ›‚","ðŸ›ƒ","ðŸ›„","ðŸ›…","â™¿","ðŸš¾","ðŸš°","ðŸš¹","ðŸšº","ðŸš»"] },
                    8: { cols: 13, emojis: ["!","@","#","$","%","^","&","*",":",";","?","<",">"] },
                }
             },
             "I":{
                isUnlocked: true, 
                progress: 1,
                maxProgress: 17,
                type: "timing",
                isComplete: false,
                config: { 
                    1: { speed: 1.0, zones: 1, width: 20.0 },  
                    2: { speed: 1.0, zones: 1, width: 18.0 },
                    3: { speed: 1.1, zones: 1, width: 18.0 },
                    4: { speed: 1.2, zones: 1, width: 16.0 },
                    5: { speed: 1.2, zones: 1, width: 15.0 },
                    6: { speed: 1.3, zones: 1, width: 14.0 },  
                    7: { speed: 1.4, zones: 1, width: 13.0 },
                    8: { speed: 1.4, zones: 1, width: 10.0 },
                    9: { speed: 1.5, zones: 1, width: 9.5 },
                    10: { speed: 1.5, zones: 1, width: 8.0 }, 
                    11: { speed: 1.6, zones: 1, width: 6.0 },
                    12: { speed: 1.7, zones: 1, width: 6.0 },
                    13: { speed: 1.7, zones: 1, width: 5.0 }, 
                    14: { speed: 1.8, zones: 1, width: 4.5 },
                    15: { speed: 1.9, zones: 1, width: 4.0 },
                    16: { speed: 2.0, zones: 1, width: 3.0 },
                    17: { speed: 2.0, zones: 1, width: 2.8 } 
                }
             }
        };

        // State Minigame Lokal code: quest
        let isMinigameOpen = false;
        let memoryBoardLocked = false;
        let firstCard = null;
        let secondCard = null;
        let matchesFound = 0;
        let minigameCompleteProgress = 0

        // --- MINIGAME SYSTEM ---
        const minigameLayer = document.getElementById('minigameLayer');
        const memoryBoard = document.getElementById('memoryBoard');
        const minigameProgress = document.getElementById('minigameProgress');
        const minigameMessage = document.getElementById('minigameMessage');

        // Fungsi Toggle (Dipanggil oleh Tombol Aktivasi)
        function togglePanelActivation() {
            if (!isMinigameOpen) {
                openMinigame();
            } else {
                closeMinigame();
            }
        }

       function openMinigame() {
        const quest = questData[currentLocation];
        if (!quest || quest.isComplete) return;

        isMinigameOpen = true;
        minigameLayer.style.display = 'flex';

        // Set atribut data-type untuk CSS
        minigameLayer.dataset.type = quest.type; 

        // Ubah tampilan Tombol Aktivasi
        PanelActivationBtn.innerText = "TUTUP AKTIVASI";
        PanelActivationBtn.style.backgroundColor = "rgba(200, 0, 0, 0.6)";

        // Inisialisasi Minigame sesuai tipe
        if (quest.type === 'memory') {
            initMemoryLevel(quest.progress);
        } else if (quest.type === 'timing') {
            initTimingLevel(quest.progress);
        }
    }

      function closeMinigame() {
        isMinigameOpen = false;
        minigameLayer.style.display = 'none';
        timingHitBtn.style.display ="none"

        // Hentikan interval Timing Game jika sedang berjalan
        if (timingGameInterval) {
            clearInterval(timingGameInterval);
        }

        // Kembalikan Tombol Aktivasi
        PanelActivationBtn.innerText = "AKTIFASI PANEL";
        PanelActivationBtn.style.backgroundColor = "";

        // Reset state memory board
        resetBoard(); 
    }

        function initMemoryLevel(level) {
            memoryBoard.innerHTML = ''; // Bersihkan board
            const quest = questData[currentLocation];
            const cfg = quest.config[level];

            minigameProgress.innerText = `LEVEL ${level}/${quest.maxProgress}`;
            
            // 1. Siapkan Deck
            let deck = [...cfg.emojis, ...cfg.emojis]; // Duplikasi untuk pasangan
            deck.sort(() => 0.5 - Math.random()); // Shuffle

            // 2. Setup Grid CSS secara dinamis
            // Level 1 (6 kartu): 3 kolom
            // Level 2 (10 kartu): 5 kolom
            // Level 3 (14 kartu): 7 kolom
            memoryBoard.style.gridTemplateColumns = `repeat(${cfg.cols}, 1fr)`;

            // 3. Render Kartu
            matchesFound = 0;
            
            deck.forEach(emoji => {
                const card = document.createElement('div');
                card.classList.add('memory-card');
                card.dataset.emoji = emoji;
                card.innerText = 'â”'; // Awalnya kosong (tertutup)

                card.addEventListener('click', () => flipCard(card));
                memoryBoard.appendChild(card);
            });
        }

        function flipCard(card) {
            // Cegah klik jika board terkunci, kartu sama, atau sudah match
            if (memoryBoardLocked) return;
            if (card === firstCard) return;
            if (card.classList.contains('matched')) return;

            // Efek Suara & Visual
            minigamePanelClickSfx.currentTime = 0;
            minigamePanelClickSfx.play();
            
            card.classList.add('flipped');
            card.innerText = card.dataset.emoji; // Tampilkan Emoji

            if (!firstCard) {
                // Kartu Pertama
                firstCard = card;
                return;
            }

            // Kartu Kedua
            secondCard = card;
            checkForMatch();
        }

        function checkForMatch() {
            let isMatch = firstCard.dataset.emoji === secondCard.dataset.emoji;

            if (isMatch) {
                disableCards();
            } else {
                unflipCards();
            }
        }

        function disableCards() {
            // MATCH!
            correctSfx.currentTime = 0;
            correctSfx.play();

            firstCard.classList.add('matched');
            secondCard.classList.add('matched');
            
            matchesFound++;
            resetBoard();

            // Cek Win Condition per Level
            const quest = questData[currentLocation];
            const totalPairs = quest.config[quest.progress].emojis.length;

            if (matchesFound === totalPairs) {
                setTimeout(levelUp, 500);
            }
        }

        function levelUp() {
        const quest = questData[currentLocation];

        if (quest.progress < quest.maxProgress) {
            // NAIK LEVEL
            quest.progress++;
            initMemoryLevel(quest.progress);
        } else {
            // QUEST SELESAI
            quest.isComplete = true;
            minigameComplete(); 
        }
    }

        function unflipCards() {
            // TIDAK MATCH
            incorrectSfx.currentTime = 0;
            incorrectSfx.play();
            
            memoryBoardLocked = true; // Kunci board sebentar

            setTimeout(() => {
                firstCard.classList.remove('flipped');
                firstCard.innerText = 'â”';
                
                secondCard.classList.remove('flipped');
                secondCard.innerText = 'â”';
                
                resetBoard();
            }, 800); // Tunggu 0.8 detik
        }

        function resetBoard() {
            [memoryBoardLocked, firstCard, secondCard] = [false, null, null];
        }

        function levelUp() {
            const quest = questData[currentLocation];
            
            if (quest.progress < quest.maxProgress) {
                // NAIK LEVEL
                quest.progress++;
                initMemoryLevel(quest.progress);
            } else {
                // QUEST SELESAI
                quest.isComplete = true;
                minigameComplete()
            }
        }

        // --- TIMING GAME SYSTEM ---
        const timingBarContainer = document.getElementById('timingBarContainer');
        const redLine = document.getElementById('redLine');
        const hitZonesContainer = document.getElementById('hitZones');
        const timingHitBtn = document.getElementById('timingHitBtn');

        let timingGameInterval = null;
        let linePosition = 0; // Posisi 0% sampai 100%
        let lineDirection = 1; // 1 = Kanan, -1 = Kiri

        // Fungsi yang dipanggil saat membuka minigame
        function initTimingLevel(level) {
            const quest = questData[currentLocation];
            const cfg = quest.config[level];
            timingHitBtn.style.display ="block"

            minigameProgress.innerText = `LEVEL ${level}/${quest.maxProgress}`;

            // Reset
            hitZonesContainer.innerHTML = '';
            clearInterval(timingGameInterval);
            linePosition = 0;
            lineDirection = 1;

            // Pastikan transform di-reset manual
            redLine.style.transform = `translateX(0%)`;

            // 1. Buat Hit Zones (Garis Kuning)
            const availableWidth = 100 - (cfg.zones * cfg.width);
            let positions = [];
            
            // Generate posisi awal random
            for (let i = 0; i < cfg.zones; i++) {
                // Pilih posisi acak yang tidak tumpang tindih
                let newPos;
                let overlap;
                do {
                    overlap = false;
                    // Pastikan ada ruang untuk zona dan lebar garis merah
                    newPos = Math.random() * (100 - cfg.width - 0.5); 
                    
                    // Cek tumpang tindih dengan zona yang sudah ada
                    for (let existingPos of positions) {
                        if (Math.abs(newPos - existingPos) < (cfg.width + 1)) { // +1 untuk jarak aman
                            overlap = true;
                            break;
                        }
                    }
                } while (overlap);
                positions.push(newPos);
            }
            
            positions.sort((a, b) => a - b);

            positions.forEach(pos => {
                const zone = document.createElement('div');
                zone.classList.add('hit-zone');
                zone.style.width = `${cfg.width}%`;
                zone.style.left = `${pos}%`;
                zone.dataset.start = pos;
                zone.dataset.end = pos + cfg.width;
                hitZonesContainer.appendChild(zone);
            });
            // 2. Mulai Pergerakan Bar
                        timingGameInterval = setInterval(() => {
                            // Kecepatan tergantung level (speed multiplier)
                            const step = 0.5 * cfg.speed * lineDirection; 
                            linePosition += step;
            
                            // Batas Balik Arah
                            // UBAH 0.5 MENJADI 1.0 (Sesuai lebar CSS #redLine 1%)
                            const maxPos = 100 - 1.0; 
                            
                            if (linePosition >= maxPos) {
                                lineDirection = -1;
                                linePosition = maxPos;
                            } else if (linePosition <= 0) {
                                lineDirection = 1;
                                linePosition = 0;
                            }
            
                            redLine.style.transform = `translateX(${linePosition*100}%)`;
                        }, 20); // Update setiap 10ms
        }

        // Fungsi dipanggil saat tombol HIT ditekan
        function checkTimingHit() {
            if (!isMinigameOpen || questData[currentLocation].type !== 'timing') return;
            
            minigamePanelClickSfx.currentTime = 0;
            minigamePanelClickSfx.play();

            const hitZones = document.querySelectorAll('#hitZones .hit-zone');
            let isHit = false;

            // Cek apakah Garis Merah berada di dalam Garis Kuning
            hitZones.forEach(zone => {
                const start = parseFloat(zone.dataset.start);
                const end = parseFloat(zone.dataset.end);

                // Hit jika posisi garis merah berada di antara start dan end zone
                if (linePosition >= start && linePosition <= end) {
                    isHit = true;
                }
            });

            if (isHit) {
                timingGameSuccess();
            } else {
                timingGameFailure();
            }
        }

        function timingGameSuccess() {
            correctSfx.currentTime = 0;
            correctSfx.play();
            
            const quest = questData[currentLocation];
            
            if (quest.progress < quest.maxProgress) {
                // NAIK LEVEL
                quest.progress++;
                // Stop interval sebelum init level baru
                clearInterval(timingGameInterval); 
                initTimingLevel(quest.progress);
            } else {
                // QUEST SELESAI
                clearInterval(timingGameInterval);
                quest.isComplete = true;
                minigameComplete(); // Panggil fungsi umum penyelesaian
            }
        }

        // Fungsi Umum Saat Quest Selesai
    function minigameComplete() {
        minigameCompleteProgress++
        minigameMessage.innerHTML = `SYSTEM RESTORED (${minigameCompleteProgress}/${Object.values(questData).length})`;
        minigameMessage.style.display = 'block';
        completeSfx.currentTime = 0; // Panggil SFX baru
        completeSfx.play(); 

        // Cek apakah semua panel selesai (Opsional: Kondisi Kemenangan Malam)
        const allComplete = Object.values(questData).every(q => q.isComplete);

        setTimeout(() => {
            minigameMessage.style.display = 'none';
            closeMinigame();
            PanelActivationBtn.style.display = 'none'; 
            if (allComplete) {
                triggerWinCondition();
            }
        }, 2500);
    }

        function timingGameFailure() {
            incorrectSfx.currentTime = 0;
            incorrectSfx.play();
            
            // Hukuman: Mundur Level (atau tetap di level yang sama jika level 1)
            const quest = questData[currentLocation];
            quest.progress = Math.max(1, quest.progress - 1); 
            
            // Re-init level
            clearInterval(timingGameInterval);
            initTimingLevel(quest.progress);
        }

        // Tambahkan event listener ke tombol HIT
        timingHitBtn.addEventListener('click', checkTimingHit);


        // --- TIME SYSTEM LOGIC ---
            function updateGameTime() {
            gameMinute++;

            if (gameMinute >= 60) {
                gameMinute = 0;
                gameHour++;
            }

            if (gameHour >= 24) {
                gameHour = 0; // Reset ke 00:00 setelah 23:59
            }
            
            checkSpawnTime();       // Cek Rustwalker
            checkTheRuinStatus();   // cek The Ruin
            checkJesterSpawnStatus(); // <-- Tambahkan ini
            checkRottenneckSpawnStatus();
            checkDevourerSpawnStatus()

            // Format String: 00:00
            const formattedHour = gameHour.toString().padStart(2, '0');
            const formattedMinute = gameMinute.toString().padStart(2, '0');
            
            // Update UI
            cctvNavbar.innerText = `${formattedHour}:${formattedMinute} --- 00:00`;
        }

        function startClock() {
            // Update tampilan awal
            const formattedHour = gameHour.toString().padStart(2, '0');
            const formattedMinute = gameMinute.toString().padStart(2, '0');
            cctvNavbar.innerText = `${formattedHour}:${formattedMinute} --- 00:00`;

            // Jalankan timer
            clockInterval = setInterval(updateGameTime, realSecondsPerGameMinute * 1000);
        }




    // Update function startMovementSequence agar menerima targetID langsung
      function startMovementSequence(targetLocID) {
            const targetData = locationData[targetLocID];
            if (!targetData) return;

            // --- THE RUIN INTERACTION LOGIC ---
            if (theRuinData.isActive) {
                // Cek apakah target ada di LANTAI BERBEDA?
                const currentFloor = locationData[currentLocation].playerData.floor;
                const targetFloor = targetData.playerData.floor;

                if (currentFloor === targetFloor) {
                    // KESALAHAN FATAL: Pindah ruangan di lantai yang sama saat Ruin ada
                    triggerRuinJumpscare("Kabur ke ruangan sebelah (Salah)");
                    return; // Batalkan perpindahan
                } else {
                    // SUKSES: Pemain pindah lantai
                    console.log("[THE RUIN] Pemain berhasil kabur ke lantai lain!");
                    resetTheRuin(true); // True = Selamat
                }
            }

            if (rottenneckData.active && rottenneckData.phase === 2) {
                // Rottenneck aktif dan sedang di Fase 2 (visual muncul)
                console.log("[ROTTENNECK] Jumpscare! Player mencoba pindah area saat Rottenneck menyerang.");
                
                // Hentikan perpindahan area
                // Bersihkan timer dan interval Rottenneck yang sedang berjalan
                clearInterval(rottenneckStareInterval);
                clearTimeout(rottenneckData.failTimer);
                
                // Panggil jumpscare
                triggerJumpscare('The Rottenneck'); 

                return; // Hentikan fungsi agar perpindahan tidak terjadi
            }

            // --- TAMBAHAN: JESTER DEADLY MISTAKE ---
            if (jesterData.state === 2 && targetLocID === jesterData.location) {
                console.log("[GAME OVER] Player berjalan ke arah Jester!");
                // Hentikan logic Jester
                clearInterval(jesterPhase2CheckInterval);
                thejesterHuntSfx.pause();
                
                // Trigger Jumpscare Instant
                checkPlayerCollision('TheJester'); 
                return;
            }
            // ----------------------------------

            isMoving = true;
            navLayer.style.pointerEvents = "none"; 

            currentLocation = targetLocID;
            playerData = targetData.playerData;

            transitionOverlay.style.opacity = 1;

            setTimeout(() => {
                footstepPlayerSfx.currentTime = 0;
                footstepPlayerSfx.play();

                setTimeout(() => {
                    mainImg1.src = targetData.images[0];
                    mainImg2.src = targetData.images[1];
                    mainImg3.src = targetData.images[2];
                    
                    console.log(`Assets pre-loaded for ${targetLocID}`);
                    currentPan = 50
                }, 2500); 

                setTimeout(() => {
                    finishMovement(targetLocID, targetData);
                }, 5000); 

            }, 1000); 
        }

      function finishMovement(targetLocID, targetData) {
          footstepPlayerSfx.pause();
          footstepPlayerSfx.currentTime = 0;
          
            newAreaSfx.currentTime = 0;
            newAreaSfx.play();

            // Update Posisi di Map CCTV jika layar nyala
            updatePlayerMarker();

            // Render tombol baru untuk lokasi ini
            renderNavButtons();

            // update collision
            checkPlayerCollision(); 


            transitionOverlay.style.opacity = 0; // Buka layar hitam

            setTimeout(() => {
                isMoving = false;
                navLayer.style.pointerEvents = "auto"; // Hidupkan klik lagi
            }, 1000); 
        }


        // --- CCTV LOGIC ---

        function switchFloor(floorNum) {
            if (currentViewFloor == floorNum) return;
            currentViewFloor = parseInt(floorNum);
            floorPlan.src = floorData[currentViewFloor] || floorData[3];

            for (let f in camGroups) camGroups[f].classList.remove('show-group'); 
            if (camGroups[currentViewFloor]) camGroups[currentViewFloor].classList.add('show-group'); 

            floorBtns.forEach(btn => {
                if (parseInt(btn.getAttribute('data-floor')) === currentViewFloor) btn.classList.add('active-floor');
                else btn.classList.remove('active-floor');
            });

            updatePlayerMarker();
            camSwitchSfx.currentTime = 0; camSwitchSfx.play();
        }

        function updatePlayerMarker() {
            if (currentViewFloor === playerData.floor) {
                posisiAnda.style.display = 'block';
                posisiAnda.style.top = playerData.mapCss.top;
                posisiAnda.style.left = playerData.mapCss.left;
            } else {
                posisiAnda.style.display = 'none';
            }
        }

        function switchCamera(camID) {
            if (currentCamera === camID) return;
            currentCamera = camID;
            cctvScreen.src = cameraData[camID] || cameraData['A'];
            camBtns.forEach(b => {
                if (b.getAttribute('data-cam') === camID) b.classList.add('active');
                else b.classList.remove('active');
            });
            updateCctvEntityVisuals();
            camSwitchSfx.currentTime = 0; camSwitchSfx.play();
        }

        // --- EVENT LISTENERS ---
        floorBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                if(!isScreenOn) return;
                switchFloor(btn.getAttribute('data-floor'));
            });
        });

        camBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                if(!isScreenOn) return;
                switchCamera(btn.getAttribute('data-cam'));
            });
        });

        const handleCctvBtn = (e) => {
            e.preventDefault()
            if (isFocusingPanel) return;

            btnSfx.currentTime = 0; btnSfx.play();
            if (isScreenOn) turnOffScreen(e);
            else toggleMonitorPosition(e);
        };

        const toggleMonitorPosition = (e) => {
            e.preventDefault()
            if (!isMonitorUp) {
                monitorWrapper.classList.replace("hideCctv", "showCctv");
                cctvBtn.innerHTML = "â–¼"; isMonitorUp = true;
            } else {
                monitorWrapper.classList.replace("showCctv", "hideCctv");
                cctvBtn.innerHTML = "â–²"; isMonitorUp = false;
            }
        };

        const turnOnScreen = (e) => {
            e.preventDefault()
            if (isMonitorUp && !isScreenOn) {
                monitorOnSfx.currentTime = 0; monitorOnSfx.play(); cctvStatic.play(); 
                cctvScreen.style.display = "block";
                cctvUiLayer.style.display = "block"; 
                cctvRustwalkerEntityImg.style.display = 'block';
                cctvFrame.style.filter="brightness(1.4)";
                cctvBtn.innerHTML = "OFF"; cctvBtn.classList.add("btn-red");
                updatePlayerMarker();
                updateCctvEntityVisuals();
                isScreenOn = true;
            }
        };

        const turnOffScreen = (e) => {
            e.preventDefault()
            monitorOnSfx.currentTime = 0; monitorOnSfx.play(); cctvStatic.pause(); cctvStatic.currentTime = 0;
            cctvScreen.style.display = "none";
            cctvUiLayer.style.display = "none"; 
            cctvRustwalkerEntityImg.style.display = 'none';
            cctvFrame.style.filter= "brightness(1)";
            cctvBtn.innerHTML = "â–¼"; cctvBtn.classList.remove("btn-red");
            isScreenOn = false;
        };

        leftZone.addEventListener('mouseenter', () => { moveDirection = -1; });
        leftZone.addEventListener('mouseleave', () => { if(moveDirection === -1) moveDirection = 0; });
        rightZone.addEventListener('mouseenter', () => { moveDirection = 1; });
        rightZone.addEventListener('mouseleave', () => { if(moveDirection === 1) moveDirection = 0; });
        
        leftZone.addEventListener('touchstart', (e) => {e.preventDefault(); moveDirection = -1; });
        leftZone.addEventListener('touchend', (e) => {e.preventDefault();  if(moveDirection === -1) moveDirection = 0; });
        rightZone.addEventListener('touchstart', (e) => {e.preventDefault();  moveDirection = 1; });
        rightZone.addEventListener('touchend', (e) => {e.preventDefault();  if(moveDirection === 1) moveDirection = 0; });



        cctvBtn.addEventListener("click", (e)=>{handleCctvBtn(e)});
        monitorWrapper.addEventListener("click", (e)=>{turnOnScreen(e)});

// --- INISIALISASI PERTAMA --- code: stx
        startBtn.addEventListener('click', () => {
            if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
            startBtn.style.display = "none";
            bgAudio.play();

            // aktivasi audio context
            footstepPlayerSfx.play(); footstepPlayerSfx.pause()
            newAreaSfx.play(); newAreaSfx.pause()
            cctvErrorSfx.play(); cctvErrorSfx.pause()
            jumpscare1Sfx.play(); jumpscare1Sfx.pause()
            theRuinSfx.play(); theRuinSfx.pause()
            thejesterMusicBoxSfx.play(); thejesterMusicBoxSfx.pause()
            thejesterHuntSfx.play(); thejesterHuntSfx.pause()
            thejesterScream.play(); thejesterScream.pause()
            thejesterPursuing.play(); thejesterPursuing.pause()
            thejesterRUN.play(); thejesterRUN.pause()
            deathScreenMusic.play(); deathScreenMusic.pause()
            openElectricalPanel.play(); openElectricalPanel.pause()
            closeElectricalPanel.play(); closeElectricalPanel.pause()
            minigamePanelClickSfx.play(); minigamePanelClickSfx.pause()
            correctSfx.play(); correctSfx.pause()
            incorrectSfx.play(); incorrectSfx.pause()
            completeSfx.play(); completeSfx.pause()
            rottenneckSFX.play(); rottenneckSFX.pause()
            rottenneckScreamSFX.play(); rottenneckScreamSFX.pause()
            devourerAppearanceSFX.play(); devourerAppearanceSFX.pause()
            devourerAmbientSFX.play(); devourerAmbientSFX.pause()
            devourerScreamSFX.play(); devourerScreamSFX.pause()
            winningMusic.play(); winningMusic.pause()
            keyboardSfx.play(); keyboardSfx.pause()
            
            calculateSpawnTime(); 
            calculateRuinFirstSpawn();
            calculateJesterFirstSpawn();
            renderNavButtons(); 
            calculateRottenneckFirstSpawn();
            calculateDevourerFirstSpawn()
            startClock(); 
            gameLoop();
            notificationData.forEach((element,index) => {
                gameNotification(index);
            });
        });

        mainContainer.style.transform = `translateX(-33.333%)`; 
        
        function gameLoop() {
            if (moveDirection !== 0 && !isMonitorUp && !isMoving) {
                currentPan += moveDirection * panSpeed;
                if (currentPan < 0) currentPan = 0;
                if (currentPan > 100) currentPan = 100;
            }
            const percentage = (currentPan / 100) * 66.666; 
            mainContainer.style.transform = `translateX(-${percentage}%)`;
            requestAnimationFrame(gameLoop);
        }

        // --- DEATH SCREEN LOGIC ---
        const deathScreen = document.getElementById('deathScreen');
        const deathFlash = document.getElementById('deathFlash');
        const deathContent = document.getElementById('deathContent');
        const deathTitle = document.getElementById('deathTitle');
        const deathSubtitle = document.getElementById('deathSubtitle');
        const deathTip = document.getElementById('deathTip');
        const deathEntityImg = document.getElementById('deathEntityImg');
        const deathTime = document.getElementById('deathTime');
        const retryBtn = document.getElementById('retryBtn');

        // Config Data Kematian
        const deathConfigData = {
            'Rustwalker': {
                img: './assets/image/deathscreen/death_rustwalker.png',
                tip: '"Cobalah untuk lebih sering memantau CCTV. Jika dia mendekat, jangan lengah sedikitpun. Dan usahakan sebisa mungkin untuk berada di area yang paling jauh dari dia!, ia hanya sebuah boneka manekin berkarat, namun ketika kamu lengah, lehermu akan patah"'
            },
            'TheRuin': {
                img: './assets/image/deathscreen/death_theruin.png',
                tip: '"The Ruin sangat membenci mereka yang diam di satu lantai. Saat dia muncul, segera PINDAH LANTAI. Ingat, senyuman lebarnya memang menandakan ekspresi yang senang, bukan karna ia jatuh cinta padamu, melainkan rasa penasaran akan merobek perutmu"'
            },
            'TheJester': {
                img: './assets/image/deathscreen/death_thejester.png',
                tip: '"Jika mendengar suara music box, berhati-hatilah! dan bersiap memantau cctv, saat suara dari music box berubah, dia sedang memburu mu. Jangan biarkan dia bersembunyi. Cari dia di CCTV dan tatap matanya sampai dia pergi. Dia luar biasa agresif dan sangat amat membenci eksistensi-mu disini"'
            },
            'Rottenneck': {
                img: './assets/image/deathscreen/death_rottenneck.png', 
                tip: '"Dengarkan baik-baik suaranya yang khas sebelum dia turun untuk memangsamu, Dia merayap di langit-langit, di sudut matamu. Jangan hanya melihat ke depan. Periksa ujung kiri dan kanan ruangan. Tatap dia sampai dia benar-benar pergi. Dia memiliki tubuh yang lincah dan memiliki bau yang sangat busuk pada lehernya"'
            },
            'The Rottenneck': { 
                img: './assets/image/deathscreen/death_rottenneck.png', 
                tip: '"Melarikan diri saat dia sudah turun adalah sebuah kesalahan yang sangat fatal. Dengarkan suara khasnya sebelum ia turun, Kamu harus menghadapinya di tempat, atau kamu akan tertangkap di udara."'
            },
            'Devourer': {
                img: './assets/image/deathscreen/death_devourer.png', 
                tip: '"Saat layar berkedip dan CCTV mati total, dia datang. Satu-satunya tempat yang aman adalah di balik pintu tertutup (Toilet). Sembunyi sebelum dia berteriak!"'
        }
        };

        // const deathTitles = ["KAMU TEWAS", "INVESTIGASI GAGAL", "MISI DIBERHENTIKAN"];
        const deathTitles = ["KAMU TEWAS", "INVESTIGASI GAGAL", "LAH MOKAD?", "YAHAHAHAHA KOK TURU", "ANDA SKILL ISSUE","BOBOK JIR",'GITU DOANG?',"BANGUN WEI","BISA YOK",'BISA MENANG, MENANGIS',"LAH KALAH","ADUHAI TURU YE","ANJAY MATI","DUDUDUH KASIAN","AMBOI KAU TEPAR","YAH MASA TEPAR",'COBA LAGI LAH','ZZZ LAH UDH BERES?', "AH KOCAK WKWKWK",'AKWOOAKWOAKW','HAKAN TAH BEUNGEUT',"HATI HATI LAH","YAH MOKAD BRE?","HMMM???","ADUDUH TEPAR DEK",'CEMAS KAU DEK',"PANIK GA? ENGGAK LAH","TUTOR DEK"];

        let deathPhase2Timer = null;

        function showDeathScreen(killerName) {
            console.log("Menampilkan Death Screen...");
            deathScreenMusic.play()
            // 1. Setup Data
            const data = deathConfigData[killerName] || deathConfigData['Rustwalker']; // Fallback
            const randomTitle = deathTitles[Math.floor(Math.random() * deathTitles.length)];
            
            deathTitle.innerText = randomTitle;
            deathSubtitle.innerText = `KAMU TERTANGKAP OLEH ${killerName.toUpperCase()}`;
            deathTip.innerText = data.tip;
            deathEntityImg.src = data.img;

            // Format Waktu Bertahan
            const finalHour = gameHour.toString().padStart(2, '0');
            const finalMinute = gameMinute.toString().padStart(2, '0');
            deathTime.innerText = `SURVIVED UNTIL: ${finalHour}:${finalMinute}`;

            // 2. Tampilkan Layar Hitam (Awal)
            deathScreen.style.display = 'flex';
            
            // 3. (1 Detik kemudian) Kilatan Merah
            setTimeout(() => {
                deathFlash.classList.add('red-flash-anim');
                viewport.style.display ="none"
                
                // 4. (0.6 Detik setelah kilatan) Teks Muncul
                setTimeout(() => {
                    deathContent.style.opacity = 1;

                    // Setup Listener untuk Phase 2 (Klik atau Timeout 5 detik)
                    deathScreen.style.cursor = "pointer";
                    
                    // Auto Phase 2 setelah 5 detik
                    deathPhase2Timer = setTimeout(() => {
                        triggerDeathPhase2();
                    }, 5000);

                    // Klik untuk mempercepat Phase 2
                    deathScreen.onclick = () => {
                        triggerDeathPhase2();
                    };

                }, 800); // 0.8s after flash starts

            }, 1000); // 1s wait
        }

        function triggerDeathPhase2() {
            if (deathScreen.classList.contains('phase-2')) return; 
            
            clearTimeout(deathPhase2Timer);
            deathScreen.onclick = null; 
            deathScreen.style.cursor = "default";

            // Trigger CSS Class untuk transisi
            deathScreen.classList.add('phase-2');
        }

        // Tombol Ulangi
        retryBtn.addEventListener('click', () => {
            location.reload();
        });

        // --- WINNING SYSTEM ---
        const winningScreen = document.getElementById('winningScreen');
        const winningTitle = document.getElementById('winningTitle');
        const winningSubtitle = document.getElementById('winningSubtitle');
        const winGameTime = document.getElementById('winGameTime');
        const winningStats = document.getElementById('winningStats');
        const winningButtons = document.getElementById('winningButtons');
        const winRetryBtn = document.getElementById('winRetryBtn');
        const winMenuBtn = document.getElementById('winMenuBtn');

        const winTitles = ["MISI SELESAI", "KAMU BERHASIL", "MALAM SELESAI"];
        const winSubtitles = "Selamat, Anda telah melakukan aktivasi terhadap semua panel listrik pada bangunan ini.";

        function triggerWinCondition() {
            console.log("[GAME WON] All panels activated!");

            // 1. STOP SEMUA SISTEM (Game Freeze)
            clearInterval(clockInterval);
            clearInterval(jesterPhase2CheckInterval); 
            clearTimeout(rustwalkerMoveTimer);
            clearTimeout(theRuinData.deathTimer);
            clearTimeout(rottenneckData.failTimer); 
            clearInterval(rottenneckStareInterval);
            
            // Kunci Input
            isMoving = true; 
            navLayer.style.pointerEvents = "none"; 
            cctvBtn.style.pointerEvents = "none"; 
            monitorWrapper.style.display = 'none'; 
            cctvBtn.style.display = 'none';

            // 2. MATIKAN AUDIO LINGKUNGAN
            bgAudio.pause();
            cctvStatic.pause();
            devourerAmbientSFX.pause();
            // Matikan audio musuh lain jika sedang main...

            // 3. MULAI SEQUENSI KEMENANGAN
            winningMusic.currentTime = 0;
            winningMusic.play();

            // Tampilkan Layar (Fade In)
            winningScreen.style.display = 'flex';
            // Force reflow
            void winningScreen.offsetWidth;
            winningScreen.style.opacity = 1;

            // 4. EFEK MENGETIK (Typewriter)
            // Pilih Judul Acak
            const chosenTitle = winTitles[Math.floor(Math.random() * winTitles.length)];
            
            // Mulai ngetik Judul dulu
            typeWriter(winningTitle, chosenTitle, 100, () => {
                // Setelah judul selesai, ketik Subjudul
                setTimeout(() => {
                    typeWriter(winningSubtitle, winSubtitles, 50, () => {
                        // Setelah subjudul selesai, tampilkan Stats & Tombol
                        showWinStats();
                    });
                }, 500);
            });
        }

        function typeWriter(element, text, speed, callback) {
            let i = 0;
            element.innerHTML = ""; // Bersihkan teks awal
            
            function type() {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                    
                    // Efek Suara Keyboard (Randomize pitch/volume dikit biar natural opsional)
                    keyboardSfx.currentTime = 0;
                    keyboardSfx.play();

                    setTimeout(type, speed);
                } else {
                    if (callback) callback();
                }
            }
            type();
        }

        function showWinStats() {
            // Set Waktu Selesai
            const finalHour = gameHour.toString().padStart(2, '0');
            const finalMinute = gameMinute.toString().padStart(2, '0');
            winGameTime.innerText = `WAKTU GAME SELESAI: ${finalHour}:${finalMinute}`;

            // Fade In Stats & Buttons
            winningStats.style.opacity = 1;
            winningButtons.style.opacity = 1;
            winningButtons.style.pointerEvents = 'auto'; // Aktifkan klik
        }

        // --- EVENT LISTENERS TOMBOL WIN ---
        winRetryBtn.addEventListener('click', () => {
            location.reload();
        });

        winMenuBtn.addEventListener('click', () => {
            window.location.href = "./lobby.html";
        });


    </script>
</body>
</html>
